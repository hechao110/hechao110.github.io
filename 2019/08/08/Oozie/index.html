<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  

  
  <title>Oozie | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Oozie一 概述 是一个工作流调度软件 本身属于cloudera 后来贡献给了apache oozie目的根据一个定义DAG（有向无环图）执行工作流程 oozie本身的配置是一种xml格式的配置文件 oozie跟hue配合使用将会很方便 oozie特点：顺序执行 周期重复定时 可视化 追踪结果  二 架构Oozie Client：提供命令行、java api、rest等方式，对Oozie的工作流">
<meta property="og:type" content="article">
<meta property="og:title" content="Oozie">
<meta property="og:url" content="http://yoursite.com/2019/08/08/Oozie/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Oozie一 概述 是一个工作流调度软件 本身属于cloudera 后来贡献给了apache oozie目的根据一个定义DAG（有向无环图）执行工作流程 oozie本身的配置是一种xml格式的配置文件 oozie跟hue配合使用将会很方便 oozie特点：顺序执行 周期重复定时 可视化 追踪结果  二 架构Oozie Client：提供命令行、java api、rest等方式，对Oozie的工作流">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://manzhong.github.io/images/Oozie/lc.png">
<meta property="og:image" content="https://manzhong.github.io/images/Oozie/lx1.png">
<meta property="og:image" content="https://manzhong.github.io/images/Oozie/lx2.png">
<meta property="og:image" content="https://manzhong.github.io/images/Oozie/lx3.png">
<meta property="og:updated_time" content="2019-08-08T03:46:03.668Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Oozie">
<meta name="twitter:description" content="Oozie一 概述 是一个工作流调度软件 本身属于cloudera 后来贡献给了apache oozie目的根据一个定义DAG（有向无环图）执行工作流程 oozie本身的配置是一种xml格式的配置文件 oozie跟hue配合使用将会很方便 oozie特点：顺序执行 周期重复定时 可视化 追踪结果  二 架构Oozie Client：提供命令行、java api、rest等方式，对Oozie的工作流">
<meta name="twitter:image" content="https://manzhong.github.io/images/Oozie/lc.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Oozie" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/08/08/Oozie/" class="article-date">
  <time datetime="2019-08-08T03:40:50.000Z" itemprop="datePublished">2019-08-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Oozie
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Oozie"><a href="#Oozie" class="headerlink" title="Oozie"></a>Oozie</h1><h2 id="一-概述"><a href="#一-概述" class="headerlink" title="一 概述"></a>一 概述</h2><ul>
<li>是一个工作流调度软件 本身属于cloudera 后来贡献给了apache</li>
<li>oozie目的根据一个定义DAG（有向无环图）执行工作流程</li>
<li>oozie本身的配置是一种xml格式的配置文件 oozie跟hue配合使用将会很方便</li>
<li>oozie特点：顺序执行 周期重复定时 可视化 追踪结果</li>
</ul>
<h1 id="二-架构"><a href="#二-架构" class="headerlink" title="二 架构"></a>二 架构</h1><p><strong>Oozie Client</strong>：提供命令行、java api、rest等方式，对Oozie的工作流流程的提交、启动、运行等操作；</p>
<p><strong>Oozie WebApp</strong>：即 Oozie Server,本质是一个java应用。可以使用内置的web容器，也可以使用外置的web容器；</p>
<p><strong>Hadoop Cluster</strong>：底层执行Oozie编排流程的各个hadoop生态圈组件；launcher Job(single map task no reduce task) 和actual program(mr hive pig sqark etc) <strong>oozie各种类型任务提交底层依赖于mr程序 首先启动一个没有reducetak的mr 通过这个mr把各个不同类型的任务提交到具体的集群上执行</strong></p>
<h1 id="三-原理"><a href="#三-原理" class="headerlink" title="三 原理"></a>三 原理</h1><p> Oozie对工作流的编排，是基于workflow.xml文件来完成的。用户预先将工作流执行规则定制于workflow.xml文件中，并在job.properties配置相关的参数，然后由Oozie Server向MR提交job来启动工作流。</p>
<h2 id="1-流程节点"><a href="#1-流程节点" class="headerlink" title="1 流程节点"></a>1 流程节点</h2><p><strong>Control Flow Nodes</strong>：控制工作流执行路径，包括start，end，kill，decision判断的节点，fork 插值 分开执行不同的任务 并行执行,join 合并。</p>
<p><strong>Action Nodes</strong>：决定每个操作执行的任务类型，包括MapReduce、java、hive、shell等。</p>
<p><a href="https://manzhong.github.io/images/Oozie/lc.png" target="_blank" rel="noopener"><img src="https://manzhong.github.io/images/Oozie/lc.png" alt="img"></a></p>
<p>上述两种类型结合起来 就可以描绘出一个工作流的DAG图。</p>
<h2 id="2-工作流类型"><a href="#2-工作流类型" class="headerlink" title="2 工作流类型"></a>2 工作流类型</h2><ul>
<li><ul>
<li>workflow 基本类型的工作流 只会按照定义顺序执行 无定时触发和条件触发</li>
<li><a href="https://manzhong.github.io/images/Oozie/lx1.png" target="_blank" rel="noopener"><img src="https://manzhong.github.io/images/Oozie/lx1.png" alt="img"></a></li>
</ul>
</li>
<li><p>coordinator Coordinator将多个工作流Job组织起来，称为Coordinator<br>Job，并指定触发时间和频率，还可以配置数据集、并发数等，类似于在工作流外部增加了一个协调器来管理这些工作流的工作流Job的运行。</p>
<ul>
<li><p><a href="https://manzhong.github.io/images/Oozie/lx2.png" target="_blank" rel="noopener"><img src="https://manzhong.github.io/images/Oozie/lx2.png" alt="img"></a></p>
</li>
<li><p>bundle 针对coordinator的批处理工作流。Bundle将多个Coordinator管理起来，这样我们只需要一个Bundle提交即可。</p>
<p><a href="https://manzhong.github.io/images/Oozie/lx3.png" target="_blank" rel="noopener"><img src="https://manzhong.github.io/images/Oozie/lx3.png" alt="img"></a></p>
</li>
</ul>
</li>
</ul>
<h1 id="四-Apache-Oozie-安装"><a href="#四-Apache-Oozie-安装" class="headerlink" title="四 Apache Oozie 安装"></a>四 Apache Oozie 安装</h1><p>版本问题：Apache官方提供的是源码包 需要自己结合hadoop生态圈软件环境进行编译 兼容性问题特别难以处理 因此可以使用第三方商业公司编译好 Cloudera（CDH）</p>
<h2 id="1-修改Hadoop的配置"><a href="#1-修改Hadoop的配置" class="headerlink" title="1 修改Hadoop的配置"></a>1 修改Hadoop的配置</h2><h3 id="1-1-配置httpfs服务"><a href="#1-1-配置httpfs服务" class="headerlink" title="1.1 配置httpfs服务"></a>1.1 配置httpfs服务</h3><p>修改Hadoop的配置文件core-site.xml：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;property&gt;</span><br><span class="line">        &lt;name&gt;hadoop.proxyuser.root.hosts&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;*&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">        &lt;name&gt;hadoop.proxyuser.root.groups&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;*&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br></pre></td></tr></table></figure>

<p><code>hadoop.proxyuser.root.hosts</code>允许通过httpfs方式访问hdfs的主机名、域名；</p>
<p><code>hadoop.proxyuser.root.groups</code>允许访问的客户端的用户组</p>
<h3 id="1-2-配置jobhistory服务"><a href="#1-2-配置jobhistory服务" class="headerlink" title="1.2 配置jobhistory服务"></a>1.2 配置jobhistory服务</h3><p>修改Hadoop的配置文件mapred-site.xml:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;property&gt;</span><br><span class="line">  &lt;name&gt;mapreduce.jobhistory.address&lt;/name&gt;</span><br><span class="line">  &lt;value&gt;node01:10020&lt;/value&gt;</span><br><span class="line">  &lt;description&gt;MapReduce JobHistory Server IPC host:port&lt;/description&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line"></span><br><span class="line">&lt;property&gt;</span><br><span class="line">  &lt;name&gt;mapreduce.jobhistory.webapp.address&lt;/name&gt;</span><br><span class="line">  &lt;value&gt;node01:19888&lt;/value&gt;</span><br><span class="line">  &lt;description&gt;MapReduce JobHistory Server Web UI host:port&lt;/description&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line">&lt;!-- 配置运行过的日志存放在hdfs上的存放路径 --&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">    &lt;name&gt;mapreduce.jobhistory.done-dir&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;/export/data/history/done&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 配置正在运行中的日志在hdfs上的存放路径 --&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">    &lt;name&gt;mapreduce.jobhistory.intermediate-done-dir&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;/export/data/history/done_intermediate&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br></pre></td></tr></table></figure>

<h3 id="1-3-重启hadoop集群相关服务"><a href="#1-3-重启hadoop集群相关服务" class="headerlink" title="1.3 重启hadoop集群相关服务"></a>1.3 重启hadoop集群相关服务</h3><p>启动history-server</p>
<p>mr-jobhistory-daemon.sh start historyserver</p>
<p>停止history-server</p>
<p>mr-jobhistory-daemon.sh stop historyserver</p>
<p>通过浏览器访问Hadoop Jobhistory的WEBUI</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://node01:19888</span><br></pre></td></tr></table></figure>

<h2 id="2-解压-Oozie的安装包"><a href="#2-解压-Oozie的安装包" class="headerlink" title="2 解压 Oozie的安装包"></a>2 解压 Oozie的安装包</h2><p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">oozie的安装包上传到/export/softwares</span><br><span class="line">tar -zxvf oozie-4.1.0-cdh5.14.0.tar.gz -C ../servers/</span><br><span class="line"></span><br><span class="line">解压hadooplibs到与oozie平行的目录</span><br><span class="line">cd /export/servers/oozie-4.1.0-cdh5.14.0</span><br><span class="line">tar -zxvf oozie-hadooplibs-4.1.0-cdh5.14.0.tar.gz -C ../</span><br></pre></td></tr></table></figure>

<h2 id="3-添加相关依赖"><a href="#3-添加相关依赖" class="headerlink" title="3 添加相关依赖"></a>3 添加相关依赖</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">oozie的安装路径下创建libext目录</span><br><span class="line">cd /export/servers/oozie-4.1.0-cdh5.14.0</span><br><span class="line">mkdir -p libext</span><br><span class="line"></span><br><span class="line">拷贝hadoop依赖包到libext</span><br><span class="line">cd /export/servers/oozie-4.1.0-cdh5.14.0</span><br><span class="line">cp -ra hadooplibs/hadooplib-2.6.0-cdh5.14.0.oozie-4.1.0-cdh5.14.0/* libext/</span><br><span class="line"></span><br><span class="line">上传mysql的驱动包到libext</span><br><span class="line">mysql-connector-java-5.1.32.jar</span><br><span class="line">添加ext-2.2.zip压缩包到libext</span><br><span class="line">ext-2.2.zip</span><br></pre></td></tr></table></figure>

<h2 id="4-修改oozie-site-xml文件"><a href="#4-修改oozie-site-xml文件" class="headerlink" title="4 修改oozie-site.xml文件"></a>4 修改oozie-site.xml文件</h2><p>oozie默认使用的是UTC的时区，需要在oozie-site.xml当中配置时区为<strong>GMT+0800</strong>时区</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">cd /export/servers/oozie-4.1.0-cdh5.14.0/conf</span><br><span class="line">vim oozie-site.xml</span><br><span class="line"></span><br><span class="line">	&lt;property&gt;</span><br><span class="line">        &lt;name&gt;oozie.service.JPAService.jdbc.driver&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;com.mysql.jdbc.Driver&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">	&lt;property&gt;</span><br><span class="line">        &lt;name&gt;oozie.service.JPAService.jdbc.url&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;jdbc:mysql://node03:3306/oozie&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">	&lt;property&gt;</span><br><span class="line">		&lt;name&gt;oozie.service.JPAService.jdbc.username&lt;/name&gt;</span><br><span class="line">		&lt;value&gt;root&lt;/value&gt;</span><br><span class="line">	&lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;oozie.service.JPAService.jdbc.password&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;123456&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">	&lt;property&gt;</span><br><span class="line">			&lt;name&gt;oozie.processing.timezone&lt;/name&gt;</span><br><span class="line">			&lt;value&gt;GMT+0800&lt;/value&gt;</span><br><span class="line">	&lt;/property&gt;</span><br><span class="line"></span><br><span class="line">	&lt;property&gt;</span><br><span class="line">        &lt;name&gt;oozie.service.coord.check.maximum.frequency&lt;/name&gt;</span><br><span class="line">		&lt;value&gt;false&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;     </span><br><span class="line"></span><br><span class="line">	&lt;property&gt;</span><br><span class="line">		&lt;name&gt;oozie.service.HadoopAccessorService.hadoop.configurations&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;*=/export/servers/hadoop-2.7.5/etc/hadoop&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br></pre></td></tr></table></figure>

<h2 id="5-初始化MySQL相关信息"><a href="#5-初始化MySQL相关信息" class="headerlink" title="5 初始化MySQL相关信息"></a>5 初始化MySQL相关信息</h2><p>上传oozie的解压后目录的下的yarn.tar.gz到hdfs目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/oozie-setup.sh  sharelib create -fs hdfs://node01:8020 -locallib oozie-sharelib-4.1.0-cdh5.14.0-yarn.tar.gz</span><br></pre></td></tr></table></figure>

<p>本质上就是将这些jar包解压到了hdfs上面的路径下面去</p>
<p>创建mysql数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p</span><br><span class="line">create database oozie;</span><br></pre></td></tr></table></figure>

<p>初始化创建oozie的数据库表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /export/servers/oozie-4.1.0-cdh5.14.0</span><br><span class="line">bin/oozie-setup.sh  db create -run -sqlfile oozie.sql</span><br></pre></td></tr></table></figure>

<h2 id="6-打包项目生成war包"><a href="#6-打包项目生成war包" class="headerlink" title="6 打包项目生成war包"></a>6 打包项目生成war包</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /export/servers/oozie-4.1.0-cdh5.14.0</span><br><span class="line">bin/oozie-setup.sh  prepare-war</span><br></pre></td></tr></table></figure>

<h2 id="7-配置oozie-环境变量"><a href="#7-配置oozie-环境变量" class="headerlink" title="7 配置oozie 环境变量"></a>7 配置oozie 环境变量</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/profile</span><br><span class="line"></span><br><span class="line">export OOZIE_HOME=/export/servers/oozie-4.1.0-cdh5.14.0</span><br><span class="line">export OOZIE_URL=http://node01.hadoop.com:11000/oozie</span><br><span class="line">export PATH=$PATH:$OOZIE_HOME/bin</span><br><span class="line"></span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>

<h2 id="8-启动关闭oozie服务"><a href="#8-启动关闭oozie服务" class="headerlink" title="8 启动关闭oozie服务"></a>8 启动关闭oozie服务</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">启动命令</span><br><span class="line">cd /export/servers/oozie-4.1.0-cdh5.14.0</span><br><span class="line">bin/oozied.sh start </span><br><span class="line">关闭命令</span><br><span class="line">bin/oozied.sh stop</span><br></pre></td></tr></table></figure>

<p>注意：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oozie-4.1.0-cdh5.14.0/oozie-server/temp/oozie.pid</span><br></pre></td></tr></table></figure>

<p>启动的时候产生的 pid文件，如果是kill方式关闭进程 则需要删除该文件重新启动，否则再次启动会报错。启动的时候产生的 pid文件，如果是kill方式关闭进程 则需要删除该文件重新启动，否则再次启动会报错。</p>
<h2 id="9-浏览器web-ui-页面"><a href="#9-浏览器web-ui-页面" class="headerlink" title="9 浏览器web ui 页面"></a>9 浏览器web ui 页面</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://node01:11000/oozie</span><br></pre></td></tr></table></figure>

<h2 id="10-解决oozie-页面显示异常"><a href="#10-解决oozie-页面显示异常" class="headerlink" title="10 解决oozie 页面显示异常"></a>10 解决oozie 页面显示异常</h2><p>页面访问的时候，发现oozie使用的还是GMT的时区，与我们现在的时区相差一定的时间，所以需要调整一个js的获取时区的方法，将其改成我们现在的时区。</p>
<p>修改js当中的时区问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd  oozie-server/webapps/oozie</span><br><span class="line">vim oozie-console.js</span><br><span class="line">function getTimeZone() &#123;</span><br><span class="line">    Ext.state.Manager.setProvider(new Ext.state.CookieProvider());</span><br><span class="line">    return Ext.state.Manager.get(&quot;TimezoneId&quot;,&quot;GMT+0800&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重启oozie服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /export/servers/oozie-4.1.0-cdh5.14.0</span><br><span class="line">bin/oozied.sh stop</span><br><span class="line">bin/oozied.sh start</span><br></pre></td></tr></table></figure>

<h1 id="五-Oozie的实战"><a href="#五-Oozie的实战" class="headerlink" title="五 Oozie的实战"></a>五 Oozie的实战</h1><p>oozie安装好了之后，需要测试oozie的功能是否完整好使，官方已经给自带带了各种测试案例，可以通过官方提供的各种案例来学习oozie的使用，后续也可以把这些案例作为模板在企业实际中使用。</p>
<p>先把官方提供的各种案例给解压出来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /export/servers/oozie-4.1.0-cdh5.14.0</span><br><span class="line">tar -zxvf oozie-examples.tar.gz</span><br></pre></td></tr></table></figure>

<p>创建统一的工作目录，便于集中管理oozie。企业中可任意指定路径。这里直接在oozie的安装目录下面创建工作目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /export/servers/oozie-4.1.0-cdh5.14.0</span><br><span class="line">mkdir oozie_works</span><br></pre></td></tr></table></figure>

<h2 id="1-．-优化更新hadoop相关配置"><a href="#1-．-优化更新hadoop相关配置" class="headerlink" title="1 ． 优化更新hadoop相关配置"></a>1 ． 优化更新hadoop相关配置</h2><p>1.1 yarn 容器资源 分配属性</p>
<p>yarn-site.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;!—节点最大可用内存，结合实际物理内存调整 --&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">        &lt;name&gt;yarn.nodemanager.resource.memory-mb&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;3072&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line">&lt;!—每个容器可以申请内存资源的最小值，最大值 --&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">        &lt;name&gt;yarn.scheduler.minimum-allocation-mb&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;1024&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">        &lt;name&gt;yarn.scheduler.maximum-allocation-mb&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;3072&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line"></span><br><span class="line">&lt;!—修改为Fair公平调度，动态调整资源，避免yarn上任务等待（多线程执行） --&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line"> &lt;name&gt;yarn.resourcemanager.scheduler.class&lt;/name&gt;</span><br><span class="line"> &lt;value&gt;org.apache.hadoop.yarn.server.resourcemanager.scheduler.fair.FairScheduler&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line">&lt;!—Fair调度时候是否开启抢占功能 --&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">        &lt;name&gt;yarn.scheduler.fair.preemption&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;true&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line">&lt;!—超过多少开始抢占，默认0.8--&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;yarn.scheduler.fair.preemption.cluster-utilization-threshold&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;1.0&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br></pre></td></tr></table></figure>

<p>1.2mapreduce资源申请配置</p>
<p>设置mapreduce.map.memory.mb和mapreduce.reduce.memory.mb配置</p>
<p>否则Oozie读取的默认配置 -1, 提交给yarn的时候会抛异常<em>Invalid resource request, requested memory &lt; 0, or requested memory &gt; max configured, requestedMemory=-1, maxMemory=8192</em></p>
<p><strong>mapred-site.xml</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;!—单个maptask、reducetask可申请内存大小 --&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">        &lt;name&gt;mapreduce.map.memory.mb&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;1024&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">        &lt;name&gt;mapreduce.reduce.memory.mb&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;1024&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br></pre></td></tr></table></figure>

<p>scp给其他机器 重启集群 （hadoop ） oozie</p>
<p>##1． Oozie调度shell脚本</p>
<p>把shell的任务模板拷贝到oozie的工作目录当中去</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /export/servers/oozie-4.1.0-cdh5.14.0</span><br><span class="line">cp -r examples/apps/shell/ oozie_works/</span><br></pre></td></tr></table></figure>

<p>准备待调度的shell脚本文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /export/servers/oozie-4.1.0-cdh5.14.0</span><br><span class="line">vim oozie_works/shell/hello.sh</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：这个脚本一定要是在我们oozie工作路径下的shell路径下的位置</p>
<p>#!/bin/bash</p>
<p>echo “hello world” &gt;&gt; /export/servers/hello_oozie.txt</p>
<p>修改job.properties</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cd /export/servers/oozie-4.1.0-cdh5.14.0/oozie_works/shell</span><br><span class="line">vim job.properties</span><br><span class="line"></span><br><span class="line">nameNode=hdfs://node01:8020</span><br><span class="line">jobTracker=node01:8032</span><br><span class="line">queueName=default</span><br><span class="line">examplesRoot=oozie_works</span><br><span class="line">oozie.wf.application.path=$&#123;nameNode&#125;/user/$&#123;user.name&#125;/$&#123;examplesRoot&#125;/shell</span><br><span class="line">EXEC=hello.sh</span><br></pre></td></tr></table></figure>

<p><strong>jobTracker</strong>：在hadoop2当中，jobTracker这种角色已经没有了，只有resourceManager，这里给定resourceManager的IP及端口即可。</p>
<p><strong>queueName</strong>：提交mr任务的队列名；</p>
<p><strong>examplesRoot</strong>：指定oozie的工作目录；</p>
<p><strong>oozie.wf.application.path</strong>：指定oozie调度资源存储于hdfs的工作路径；</p>
<p><strong>EXEC</strong>：指定执行任务的名称。</p>
<p>修改workflow.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&lt;workflow-app xmlns=&quot;uri:oozie:workflow:0.4&quot; name=&quot;shell-wf&quot;&gt;</span><br><span class="line">&lt;start to=&quot;shell-node&quot;/&gt;</span><br><span class="line">&lt;action name=&quot;shell-node&quot;&gt;</span><br><span class="line">    &lt;shell xmlns=&quot;uri:oozie:shell-action:0.2&quot;&gt;</span><br><span class="line">        &lt;job-tracker&gt;$&#123;jobTracker&#125;&lt;/job-tracker&gt;</span><br><span class="line">        &lt;name-node&gt;$&#123;nameNode&#125;&lt;/name-node&gt;</span><br><span class="line">        &lt;configuration&gt;</span><br><span class="line">            &lt;property&gt;</span><br><span class="line">                &lt;name&gt;mapred.job.queue.name&lt;/name&gt;</span><br><span class="line">                &lt;value&gt;$&#123;queueName&#125;&lt;/value&gt;</span><br><span class="line">            &lt;/property&gt;</span><br><span class="line">        &lt;/configuration&gt;</span><br><span class="line">        &lt;exec&gt;$&#123;EXEC&#125;&lt;/exec&gt;</span><br><span class="line">        &lt;file&gt;/user/root/oozie_works/shell/$&#123;EXEC&#125;#$&#123;EXEC&#125;&lt;/file&gt;</span><br><span class="line">        &lt;capture-output/&gt;</span><br><span class="line">    &lt;/shell&gt;</span><br><span class="line">    &lt;ok to=&quot;end&quot;/&gt;</span><br><span class="line">    &lt;error to=&quot;fail&quot;/&gt;</span><br><span class="line">&lt;/action&gt;</span><br><span class="line">&lt;decision name=&quot;check-output&quot;&gt;</span><br><span class="line">    &lt;switch&gt;</span><br><span class="line">        &lt;case to=&quot;end&quot;&gt;</span><br><span class="line">            $&#123;wf:actionData(&apos;shell-node&apos;)[&apos;my_output&apos;] eq &apos;Hello Oozie&apos;&#125;</span><br><span class="line">        &lt;/case&gt;</span><br><span class="line">        &lt;default to=&quot;fail-output&quot;/&gt;</span><br><span class="line">    &lt;/switch&gt;</span><br><span class="line">&lt;/decision&gt;</span><br><span class="line">&lt;kill name=&quot;fail&quot;&gt;</span><br><span class="line">    &lt;message&gt;Shell action failed, error message[$&#123;wf:errorMessage(wf:lastErrorNode())&#125;]&lt;/message&gt;</span><br><span class="line">&lt;/kill&gt;</span><br><span class="line">&lt;kill name=&quot;fail-output&quot;&gt;</span><br><span class="line">    &lt;message&gt;Incorrect output, expected [Hello Oozie] but was [$&#123;wf:actionData(&apos;shell-node&apos;)[&apos;my_output&apos;]&#125;]&lt;/message&gt;</span><br><span class="line">&lt;/kill&gt;</span><br><span class="line">&lt;end name=&quot;end&quot;/&gt;</span><br><span class="line">&lt;/workflow-app&gt;</span><br></pre></td></tr></table></figure>

<h3 id="1-1．-上传调度任务到hdfs"><a href="#1-1．-上传调度任务到hdfs" class="headerlink" title="1.1． 上传调度任务到hdfs"></a>1.1． 上传调度任务到hdfs</h3><p>注意：上传的hdfs目录为/user/root，因为hadoop启动的时候使用的是root用户，如果hadoop启动的是其他用户，那么就上传到/user/其他用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /export/servers/oozie-4.1.0-cdh5.14.0</span><br><span class="line">hdfs dfs -put oozie_works/ /user/root</span><br></pre></td></tr></table></figure>

<p>通过oozie的命令来执行调度任务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /export/servers/oozie-4.1.0-cdh5.14.0</span><br><span class="line"></span><br><span class="line">bin/oozie job -oozie http://node01:11000/oozie -config oozie_works/shell/job.properties  -run</span><br></pre></td></tr></table></figure>

<p>杀死任务流:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/oozie job -oozie http://node01:11000/oozie -kill job的ID</span><br></pre></td></tr></table></figure>

<p>##2． Oozie调度hive</p>
<h3 id="2-1-准备模板"><a href="#2-1-准备模板" class="headerlink" title="2.1 准备模板"></a>2.1 准备模板</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /export/servers/oozie-4.1.0-cdh5.14.0</span><br><span class="line">cp -ra examples/apps/hive2/ oozie_works/</span><br></pre></td></tr></table></figure>

<p>2.2 修改模板</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">修改job.properties</span><br><span class="line">cd /export/servers/oozie-4.1.0-cdh5.14.0/oozie_works/hive2</span><br><span class="line">vim job.properties</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">nameNode=hdfs://node01:8020</span><br><span class="line">jobTracker=node01:8032</span><br><span class="line">queueName=default</span><br><span class="line">jdbcURL=jdbc:hive2://node01:10000/default</span><br><span class="line">examplesRoot=oozie_works</span><br><span class="line"></span><br><span class="line">oozie.use.system.libpath=true</span><br><span class="line"># 配置我们文件上传到hdfs的保存路径 实际上就是在hdfs 的/user/root/oozie_works/hive2这个路径下</span><br><span class="line">oozie.wf.application.path=$&#123;nameNode&#125;/user/$&#123;user.name&#125;/$&#123;examplesRoot&#125;/hive2</span><br></pre></td></tr></table></figure>

<p>修改workflow.xml（实际上无修改）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;workflow-app xmlns=&quot;uri:oozie:workflow:0.5&quot; name=&quot;hive2-wf&quot;&gt;</span><br><span class="line">    &lt;start to=&quot;hive2-node&quot;/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;action name=&quot;hive2-node&quot;&gt;</span><br><span class="line">        &lt;hive2 xmlns=&quot;uri:oozie:hive2-action:0.1&quot;&gt;</span><br><span class="line">            &lt;job-tracker&gt;$&#123;jobTracker&#125;&lt;/job-tracker&gt;</span><br><span class="line">            &lt;name-node&gt;$&#123;nameNode&#125;&lt;/name-node&gt;</span><br><span class="line">            &lt;prepare&gt;</span><br><span class="line">                &lt;delete path=&quot;$&#123;nameNode&#125;/user/$&#123;wf:user()&#125;/$&#123;examplesRoot&#125;/output-data/hive2&quot;/&gt;</span><br><span class="line">                &lt;mkdir path=&quot;$&#123;nameNode&#125;/user/$&#123;wf:user()&#125;/$&#123;examplesRoot&#125;/output-data&quot;/&gt;</span><br><span class="line">            &lt;/prepare&gt;</span><br><span class="line">            &lt;configuration&gt;</span><br><span class="line">                &lt;property&gt;</span><br><span class="line">                    &lt;name&gt;mapred.job.queue.name&lt;/name&gt;</span><br><span class="line">                    &lt;value&gt;$&#123;queueName&#125;&lt;/value&gt;</span><br><span class="line">                &lt;/property&gt;</span><br><span class="line">            &lt;/configuration&gt;</span><br><span class="line">            &lt;jdbc-url&gt;$&#123;jdbcURL&#125;&lt;/jdbc-url&gt;</span><br><span class="line">            &lt;script&gt;script.q&lt;/script&gt;</span><br><span class="line">            &lt;param&gt;INPUT=/user/$&#123;wf:user()&#125;/$&#123;examplesRoot&#125;/input-data/table&lt;/param&gt;</span><br><span class="line">            &lt;param&gt;OUTPUT=/user/$&#123;wf:user()&#125;/$&#123;examplesRoot&#125;/output-data/hive2&lt;/param&gt;</span><br><span class="line">        &lt;/hive2&gt;</span><br><span class="line">        &lt;ok to=&quot;end&quot;/&gt;</span><br><span class="line">        &lt;error to=&quot;fail&quot;/&gt;</span><br><span class="line">    &lt;/action&gt;</span><br><span class="line"></span><br><span class="line">    &lt;kill name=&quot;fail&quot;&gt;</span><br><span class="line">        &lt;message&gt;Hive2 (Beeline) action failed, error message[$&#123;wf:errorMessage(wf:lastErrorNode())&#125;]&lt;/message&gt;</span><br><span class="line">    &lt;/kill&gt;</span><br><span class="line">    &lt;end name=&quot;end&quot;/&gt;</span><br><span class="line">&lt;/workflow-app&gt;</span><br></pre></td></tr></table></figure>

<p>编辑hivesql文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim script.q</span><br><span class="line">DROP TABLE IF EXISTS test;</span><br><span class="line">CREATE EXTERNAL TABLE test (a INT) STORED AS TEXTFILE LOCATION &apos;$&#123;INPUT&#125;&apos;;</span><br><span class="line">insert into test values(10);</span><br><span class="line">insert into test values(20);</span><br><span class="line">insert into test values(30);</span><br></pre></td></tr></table></figure>

<p>上传调度任务到hdfs</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /export/servers/oozie-4.1.0-cdh5.14.0/oozie_works</span><br><span class="line">hdfs dfs -put hive2/ /user/root/oozie_works/</span><br></pre></td></tr></table></figure>

<p>执行调度任务</p>
<p>oozie调度hive脚本</p>
<ul>
<li><p>首先必须保证hiveserve2服务是启动正常的，如果配置metastore服务，要首先启动metastore</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">在hive目录下执行</span><br><span class="line">nohup hive --service metastore &amp;</span><br><span class="line">nohup hive --service hiveserver2 &amp;</span><br></pre></td></tr></table></figure>

<p>测试 hive2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">beeline</span><br><span class="line">! connect jdbc:hive2//node01:10000    看能否进去  前提node01上的hiveserve2服务是启动正常的</span><br></pre></td></tr></table></figure>

</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /export/servers/oozie-4.1.0-cdh5.14.0</span><br><span class="line">bin/oozie job -oozie http://node01:11000/oozie -config oozie_works/hive2/job.properties  -run</span><br></pre></td></tr></table></figure>

<h2 id="3-oozie-调度-MapReduce"><a href="#3-oozie-调度-MapReduce" class="headerlink" title="3 oozie 调度 MapReduce"></a>3 oozie 调度 MapReduce</h2><p>1准备模板</p>
<p>准备mr程序的待处理数据。用hadoop自带的MR程序来运行wordcount。</p>
<p>准备数据上传到HDFS的/oozie/input路径下去</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hdfs dfs -mkdir -p /oozie/input</span><br><span class="line">hdfs dfs -put wordcount.txt /oozie/input</span><br></pre></td></tr></table></figure>

<p>拷贝MR的任务模板</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /export/servers/oozie-4.1.0-cdh5.14.0</span><br><span class="line">cp -ra examples/apps/map-reduce/ oozie_works/</span><br></pre></td></tr></table></figure>

<p>删掉MR任务模板lib目录下自带的jar包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /export/servers/oozie-4.1.0-cdh5.14.0/oozie_works/map-reduce/lib</span><br><span class="line">rm -rf oozie-examples-4.1.0-cdh5.14.0.jar</span><br></pre></td></tr></table></figure>

<p>拷贝官方自带mr程序jar包到对应目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp /export/servers/hadoop-2.7.5/share/hadoop/mapreduce/hadoop-mapreduce-examples-2.7.5.jar </span><br><span class="line"> /export/servers/oozie-4.1.0-cdh5.14.0/oozie_works/map-reduce/lib/</span><br></pre></td></tr></table></figure>

<p>2 修改模板</p>
<p>修改job.properties</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cd /export/servers/oozie-4.1.0-cdh5.14.0/oozie_works/map-reduce</span><br><span class="line">vim job.properties</span><br><span class="line"></span><br><span class="line">nameNode=hdfs://node01:8020</span><br><span class="line">jobTracker=node01:8032</span><br><span class="line">queueName=default</span><br><span class="line">examplesRoot=oozie_works</span><br><span class="line">oozie.wf.application.path=$&#123;nameNode&#125;/user/$&#123;user.name&#125;/$&#123;examplesRoot&#125;/map-reduce/workflow.xml</span><br><span class="line">outputDir=/oozie/output</span><br><span class="line">inputdir=/oozie/input</span><br></pre></td></tr></table></figure>

<p>修改workflow.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">cd /export/servers/oozie-4.1.0-cdh5.14.0/oozie_works/map-reduce</span><br><span class="line">vim workflow.xml</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;workflow-app xmlns=&quot;uri:oozie:workflow:0.5&quot; name=&quot;map-reduce-wf&quot;&gt;</span><br><span class="line">    &lt;start to=&quot;mr-node&quot;/&gt;</span><br><span class="line">    &lt;action name=&quot;mr-node&quot;&gt;</span><br><span class="line">        &lt;map-reduce&gt;</span><br><span class="line">            &lt;job-tracker&gt;$&#123;jobTracker&#125;&lt;/job-tracker&gt;</span><br><span class="line">            &lt;name-node&gt;$&#123;nameNode&#125;&lt;/name-node&gt;</span><br><span class="line">            &lt;prepare&gt;</span><br><span class="line">                &lt;delete path=&quot;$&#123;nameNode&#125;/$&#123;outputDir&#125;&quot;/&gt;</span><br><span class="line">            &lt;/prepare&gt;</span><br><span class="line">            &lt;configuration&gt;</span><br><span class="line">                &lt;property&gt;</span><br><span class="line">                    &lt;name&gt;mapred.job.queue.name&lt;/name&gt;</span><br><span class="line">                    &lt;value&gt;$&#123;queueName&#125;&lt;/value&gt;</span><br><span class="line">                &lt;/property&gt;</span><br><span class="line">				&lt;!--  </span><br><span class="line">                &lt;property&gt;</span><br><span class="line">                    &lt;name&gt;mapred.mapper.class&lt;/name&gt;</span><br><span class="line">                    &lt;value&gt;org.apache.oozie.example.SampleMapper&lt;/value&gt;</span><br><span class="line">                &lt;/property&gt;</span><br><span class="line">                &lt;property&gt;</span><br><span class="line">                    &lt;name&gt;mapred.reducer.class&lt;/name&gt;</span><br><span class="line">                    &lt;value&gt;org.apache.oozie.example.SampleReducer&lt;/value&gt;</span><br><span class="line">                &lt;/property&gt;</span><br><span class="line">                &lt;property&gt;</span><br><span class="line">                    &lt;name&gt;mapred.map.tasks&lt;/name&gt;</span><br><span class="line">                    &lt;value&gt;1&lt;/value&gt;</span><br><span class="line">                &lt;/property&gt;</span><br><span class="line">                &lt;property&gt;</span><br><span class="line">                    &lt;name&gt;mapred.input.dir&lt;/name&gt;</span><br><span class="line">                    &lt;value&gt;/user/$&#123;wf:user()&#125;/$&#123;examplesRoot&#125;/input-data/text&lt;/value&gt;</span><br><span class="line">                &lt;/property&gt;</span><br><span class="line">                &lt;property&gt;</span><br><span class="line">                    &lt;name&gt;mapred.output.dir&lt;/name&gt;</span><br><span class="line">                    &lt;value&gt;/user/$&#123;wf:user()&#125;/$&#123;examplesRoot&#125;/output-data/$&#123;outputDir&#125;&lt;/value&gt;</span><br><span class="line">                &lt;/property&gt;</span><br><span class="line">				--&gt;</span><br><span class="line">				</span><br><span class="line">				   &lt;!-- 开启使用新的API来进行配置 --&gt;</span><br><span class="line">                &lt;property&gt;</span><br><span class="line">                    &lt;name&gt;mapred.mapper.new-api&lt;/name&gt;</span><br><span class="line">                    &lt;value&gt;true&lt;/value&gt;</span><br><span class="line">                &lt;/property&gt;</span><br><span class="line"></span><br><span class="line">                &lt;property&gt;</span><br><span class="line">                    &lt;name&gt;mapred.reducer.new-api&lt;/name&gt;</span><br><span class="line">                    &lt;value&gt;true&lt;/value&gt;</span><br><span class="line">                &lt;/property&gt;</span><br><span class="line"></span><br><span class="line">                &lt;!-- 指定MR的输出key的类型 --&gt;</span><br><span class="line">                &lt;property&gt;</span><br><span class="line">                    &lt;name&gt;mapreduce.job.output.key.class&lt;/name&gt;</span><br><span class="line">                    &lt;value&gt;org.apache.hadoop.io.Text&lt;/value&gt;</span><br><span class="line">                &lt;/property&gt;</span><br><span class="line"></span><br><span class="line">                &lt;!-- 指定MR的输出的value的类型--&gt;</span><br><span class="line">                &lt;property&gt;</span><br><span class="line">                    &lt;name&gt;mapreduce.job.output.value.class&lt;/name&gt;</span><br><span class="line">                    &lt;value&gt;org.apache.hadoop.io.IntWritable&lt;/value&gt;</span><br><span class="line">                &lt;/property&gt;</span><br><span class="line"></span><br><span class="line">                &lt;!-- 指定输入路径 --&gt;</span><br><span class="line">                &lt;property&gt;</span><br><span class="line">                    &lt;name&gt;mapred.input.dir&lt;/name&gt;</span><br><span class="line">                    &lt;value&gt;$&#123;nameNode&#125;/$&#123;inputdir&#125;&lt;/value&gt;</span><br><span class="line">                &lt;/property&gt;</span><br><span class="line"></span><br><span class="line">                &lt;!-- 指定输出路径 --&gt;</span><br><span class="line">                &lt;property&gt;</span><br><span class="line">                    &lt;name&gt;mapred.output.dir&lt;/name&gt;</span><br><span class="line">                    &lt;value&gt;$&#123;nameNode&#125;/$&#123;outputDir&#125;&lt;/value&gt;</span><br><span class="line">                &lt;/property&gt;</span><br><span class="line"></span><br><span class="line">                &lt;!-- 指定执行的map类 --&gt;</span><br><span class="line">                &lt;property&gt;</span><br><span class="line">                    &lt;name&gt;mapreduce.job.map.class&lt;/name&gt;</span><br><span class="line">                    &lt;value&gt;org.apache.hadoop.examples.WordCount$TokenizerMapper&lt;/value&gt;</span><br><span class="line">                &lt;/property&gt;</span><br><span class="line"></span><br><span class="line">                &lt;!-- 指定执行的reduce类 --&gt;</span><br><span class="line">                &lt;property&gt;</span><br><span class="line">                    &lt;name&gt;mapreduce.job.reduce.class&lt;/name&gt;</span><br><span class="line">                    &lt;value&gt;org.apache.hadoop.examples.WordCount$IntSumReducer&lt;/value&gt;</span><br><span class="line">                &lt;/property&gt;</span><br><span class="line">				&lt;!--  配置map task的个数 --&gt;</span><br><span class="line">                &lt;property&gt;</span><br><span class="line">                    &lt;name&gt;mapred.map.tasks&lt;/name&gt;</span><br><span class="line">                    &lt;value&gt;1&lt;/value&gt;</span><br><span class="line">                &lt;/property&gt;</span><br><span class="line"></span><br><span class="line">            &lt;/configuration&gt;</span><br><span class="line">        &lt;/map-reduce&gt;</span><br><span class="line">        &lt;ok to=&quot;end&quot;/&gt;</span><br><span class="line">        &lt;error to=&quot;fail&quot;/&gt;</span><br><span class="line">    &lt;/action&gt;</span><br><span class="line">    &lt;kill name=&quot;fail&quot;&gt;</span><br><span class="line">        &lt;message&gt;Map/Reduce failed, error message[$&#123;wf:errorMessage(wf:lastErrorNode())&#125;]&lt;/message&gt;</span><br><span class="line">    &lt;/kill&gt;</span><br><span class="line">    &lt;end name=&quot;end&quot;/&gt;</span><br><span class="line">&lt;/workflow-app&gt;</span><br></pre></td></tr></table></figure>

<p>3 上传调度任务到hdfs</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /export/servers/oozie-4.1.0-cdh5.14.0/oozie_works hdfs dfs -put map-reduce/ /user/root/oozie_works/</span><br></pre></td></tr></table></figure>

<p>4 执行任务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /export/servers/oozie-4.1.0-cdh5.14.0</span><br><span class="line">bin/oozie job -oozie http://node01:11000/oozie -config oozie_works/map-reduce/job.properties -run</span><br></pre></td></tr></table></figure>

<p>注意:</p>
<p>需要在workflow.xml中开启使用新版的 api hadoop2.x</p>
<h2 id="4-oozie-任务串联"><a href="#4-oozie-任务串联" class="headerlink" title="4 oozie 任务串联"></a>4 oozie 任务串联</h2><p>在实际工作当中，肯定会存在多个任务需要执行，并且存在上一个任务的输出结果作为下一个任务的输入数据这样的情况，所以我们需要在workflow.xml配置文件当中配置多个action，实现多个任务之间的相互依赖关系。</p>
<p>需求：首先执行一个shell脚本，执行完了之后再执行一个MR的程序，最后再执行一个hive的程序。</p>
<p>1 准备工作目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /export/servers/oozie-4.1.0-cdh5.14.0/oozie_works</span><br><span class="line">mkdir -p sereval-actions</span><br></pre></td></tr></table></figure>

<p>2 准备调度文件</p>
<p>将之前的hive，shell， MR的执行，进行串联成到一个workflow当中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /export/servers/oozie-4.1.0-cdh5.14.0/oozie_works</span><br><span class="line">cp hive2/script.q sereval-actions/</span><br><span class="line">cp shell/hello.sh sereval-actions/</span><br><span class="line">cp -ra map-reduce/lib sereval-actions/</span><br></pre></td></tr></table></figure>

<p>3修改配置模板</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line">cd /export/servers/oozie-4.1.0-cdh5.14.0/oozie_works/sereval-actions</span><br><span class="line">vim workflow.xml</span><br><span class="line"></span><br><span class="line">&lt;workflow-app xmlns=&quot;uri:oozie:workflow:0.4&quot; name=&quot;shell-wf&quot;&gt;</span><br><span class="line">&lt;start to=&quot;shell-node&quot;/&gt;</span><br><span class="line">&lt;action name=&quot;shell-node&quot;&gt;</span><br><span class="line">    &lt;shell xmlns=&quot;uri:oozie:shell-action:0.2&quot;&gt;</span><br><span class="line">        &lt;job-tracker&gt;$&#123;jobTracker&#125;&lt;/job-tracker&gt;</span><br><span class="line">        &lt;name-node&gt;$&#123;nameNode&#125;&lt;/name-node&gt;</span><br><span class="line">        &lt;configuration&gt;</span><br><span class="line">            &lt;property&gt;</span><br><span class="line">                &lt;name&gt;mapred.job.queue.name&lt;/name&gt;</span><br><span class="line">                &lt;value&gt;$&#123;queueName&#125;&lt;/value&gt;</span><br><span class="line">            &lt;/property&gt;</span><br><span class="line">        &lt;/configuration&gt;</span><br><span class="line">        &lt;exec&gt;$&#123;EXEC&#125;&lt;/exec&gt;</span><br><span class="line">        &lt;!-- &lt;argument&gt;my_output=Hello Oozie&lt;/argument&gt; --&gt;</span><br><span class="line">        &lt;file&gt;/user/root/oozie_works/sereval-actions/$&#123;EXEC&#125;#$&#123;EXEC&#125;&lt;/file&gt;</span><br><span class="line"></span><br><span class="line">        &lt;capture-output/&gt;</span><br><span class="line">    &lt;/shell&gt;</span><br><span class="line">    &lt;ok to=&quot;mr-node&quot;/&gt;</span><br><span class="line">    &lt;error to=&quot;mr-node&quot;/&gt;</span><br><span class="line">&lt;/action&gt;</span><br><span class="line"></span><br><span class="line">&lt;action name=&quot;mr-node&quot;&gt;</span><br><span class="line">        &lt;map-reduce&gt;</span><br><span class="line">            &lt;job-tracker&gt;$&#123;jobTracker&#125;&lt;/job-tracker&gt;</span><br><span class="line">            &lt;name-node&gt;$&#123;nameNode&#125;&lt;/name-node&gt;</span><br><span class="line">            &lt;prepare&gt;</span><br><span class="line">                &lt;delete path=&quot;$&#123;nameNode&#125;/$&#123;outputDir&#125;&quot;/&gt;</span><br><span class="line">            &lt;/prepare&gt;</span><br><span class="line">            &lt;configuration&gt;</span><br><span class="line">                &lt;property&gt;</span><br><span class="line">                    &lt;name&gt;mapred.job.queue.name&lt;/name&gt;</span><br><span class="line">                    &lt;value&gt;$&#123;queueName&#125;&lt;/value&gt;</span><br><span class="line">                &lt;/property&gt;</span><br><span class="line">				&lt;!--  </span><br><span class="line">                &lt;property&gt;</span><br><span class="line">                    &lt;name&gt;mapred.mapper.class&lt;/name&gt;</span><br><span class="line">                    &lt;value&gt;org.apache.oozie.example.SampleMapper&lt;/value&gt;</span><br><span class="line">                &lt;/property&gt;</span><br><span class="line">                &lt;property&gt;</span><br><span class="line">                    &lt;name&gt;mapred.reducer.class&lt;/name&gt;</span><br><span class="line">                    &lt;value&gt;org.apache.oozie.example.SampleReducer&lt;/value&gt;</span><br><span class="line">                &lt;/property&gt;</span><br><span class="line">                &lt;property&gt;</span><br><span class="line">                    &lt;name&gt;mapred.map.tasks&lt;/name&gt;</span><br><span class="line">                    &lt;value&gt;1&lt;/value&gt;</span><br><span class="line">                &lt;/property&gt;</span><br><span class="line">                &lt;property&gt;</span><br><span class="line">                    &lt;name&gt;mapred.input.dir&lt;/name&gt;</span><br><span class="line">                    &lt;value&gt;/user/$&#123;wf:user()&#125;/$&#123;examplesRoot&#125;/input-data/text&lt;/value&gt;</span><br><span class="line">                &lt;/property&gt;</span><br><span class="line">                &lt;property&gt;</span><br><span class="line">                    &lt;name&gt;mapred.output.dir&lt;/name&gt;</span><br><span class="line">                    &lt;value&gt;/user/$&#123;wf:user()&#125;/$&#123;examplesRoot&#125;/output-data/$&#123;outputDir&#125;&lt;/value&gt;</span><br><span class="line">                &lt;/property&gt;</span><br><span class="line">				--&gt;</span><br><span class="line">				</span><br><span class="line">				   &lt;!-- 开启使用新的API来进行配置 --&gt;</span><br><span class="line">                &lt;property&gt;</span><br><span class="line">                    &lt;name&gt;mapred.mapper.new-api&lt;/name&gt;</span><br><span class="line">                    &lt;value&gt;true&lt;/value&gt;</span><br><span class="line">                &lt;/property&gt;</span><br><span class="line"></span><br><span class="line">                &lt;property&gt;</span><br><span class="line">                    &lt;name&gt;mapred.reducer.new-api&lt;/name&gt;</span><br><span class="line">                    &lt;value&gt;true&lt;/value&gt;</span><br><span class="line">                &lt;/property&gt;</span><br><span class="line"></span><br><span class="line">                &lt;!-- 指定MR的输出key的类型 --&gt;</span><br><span class="line">                &lt;property&gt;</span><br><span class="line">                    &lt;name&gt;mapreduce.job.output.key.class&lt;/name&gt;</span><br><span class="line">                    &lt;value&gt;org.apache.hadoop.io.Text&lt;/value&gt;</span><br><span class="line">                &lt;/property&gt;</span><br><span class="line"></span><br><span class="line">                &lt;!-- 指定MR的输出的value的类型--&gt;</span><br><span class="line">                &lt;property&gt;</span><br><span class="line">                    &lt;name&gt;mapreduce.job.output.value.class&lt;/name&gt;</span><br><span class="line">                    &lt;value&gt;org.apache.hadoop.io.IntWritable&lt;/value&gt;</span><br><span class="line">                &lt;/property&gt;</span><br><span class="line"></span><br><span class="line">                &lt;!-- 指定输入路径 --&gt;</span><br><span class="line">                &lt;property&gt;</span><br><span class="line">                    &lt;name&gt;mapred.input.dir&lt;/name&gt;</span><br><span class="line">                    &lt;value&gt;$&#123;nameNode&#125;/$&#123;inputdir&#125;&lt;/value&gt;</span><br><span class="line">                &lt;/property&gt;</span><br><span class="line"></span><br><span class="line">                &lt;!-- 指定输出路径 --&gt;</span><br><span class="line">                &lt;property&gt;</span><br><span class="line">                    &lt;name&gt;mapred.output.dir&lt;/name&gt;</span><br><span class="line">                    &lt;value&gt;$&#123;nameNode&#125;/$&#123;outputDir&#125;&lt;/value&gt;</span><br><span class="line">                &lt;/property&gt;</span><br><span class="line"></span><br><span class="line">                &lt;!-- 指定执行的map类 --&gt;</span><br><span class="line">                &lt;property&gt;</span><br><span class="line">                    &lt;name&gt;mapreduce.job.map.class&lt;/name&gt;</span><br><span class="line">                    &lt;value&gt;org.apache.hadoop.examples.WordCount$TokenizerMapper&lt;/value&gt;</span><br><span class="line">                &lt;/property&gt;</span><br><span class="line"></span><br><span class="line">                &lt;!-- 指定执行的reduce类 --&gt;</span><br><span class="line">                &lt;property&gt;</span><br><span class="line">                    &lt;name&gt;mapreduce.job.reduce.class&lt;/name&gt;</span><br><span class="line">                    &lt;value&gt;org.apache.hadoop.examples.WordCount$IntSumReducer&lt;/value&gt;</span><br><span class="line">                &lt;/property&gt;</span><br><span class="line">				&lt;!--  配置map task的个数 --&gt;</span><br><span class="line">                &lt;property&gt;</span><br><span class="line">                    &lt;name&gt;mapred.map.tasks&lt;/name&gt;</span><br><span class="line">                    &lt;value&gt;1&lt;/value&gt;</span><br><span class="line">                &lt;/property&gt;</span><br><span class="line"></span><br><span class="line">            &lt;/configuration&gt;</span><br><span class="line">        &lt;/map-reduce&gt;</span><br><span class="line">        &lt;ok to=&quot;hive2-node&quot;/&gt;</span><br><span class="line">        &lt;error to=&quot;fail&quot;/&gt;</span><br><span class="line">    &lt;/action&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> &lt;action name=&quot;hive2-node&quot;&gt;</span><br><span class="line">        &lt;hive2 xmlns=&quot;uri:oozie:hive2-action:0.1&quot;&gt;</span><br><span class="line">            &lt;job-tracker&gt;$&#123;jobTracker&#125;&lt;/job-tracker&gt;</span><br><span class="line">            &lt;name-node&gt;$&#123;nameNode&#125;&lt;/name-node&gt;</span><br><span class="line">            &lt;prepare&gt;</span><br><span class="line">                &lt;delete path=&quot;$&#123;nameNode&#125;/user/$&#123;wf:user()&#125;/$&#123;examplesRoot&#125;/output-data/hive2&quot;/&gt;</span><br><span class="line">                &lt;mkdir path=&quot;$&#123;nameNode&#125;/user/$&#123;wf:user()&#125;/$&#123;examplesRoot&#125;/output-data&quot;/&gt;</span><br><span class="line">            &lt;/prepare&gt;</span><br><span class="line">            &lt;configuration&gt;</span><br><span class="line">                &lt;property&gt;</span><br><span class="line">                    &lt;name&gt;mapred.job.queue.name&lt;/name&gt;</span><br><span class="line">                    &lt;value&gt;$&#123;queueName&#125;&lt;/value&gt;</span><br><span class="line">                &lt;/property&gt;</span><br><span class="line">            &lt;/configuration&gt;</span><br><span class="line">            &lt;jdbc-url&gt;$&#123;jdbcURL&#125;&lt;/jdbc-url&gt;</span><br><span class="line">            &lt;script&gt;script.q&lt;/script&gt;</span><br><span class="line">            &lt;param&gt;INPUT=/user/$&#123;wf:user()&#125;/$&#123;examplesRoot&#125;/input-data/table&lt;/param&gt;</span><br><span class="line">            &lt;param&gt;OUTPUT=/user/$&#123;wf:user()&#125;/$&#123;examplesRoot&#125;/output-data/hive2&lt;/param&gt;</span><br><span class="line">        &lt;/hive2&gt;</span><br><span class="line">        &lt;ok to=&quot;end&quot;/&gt;</span><br><span class="line">        &lt;error to=&quot;fail&quot;/&gt;</span><br><span class="line">    &lt;/action&gt;</span><br><span class="line">&lt;decision name=&quot;check-output&quot;&gt;</span><br><span class="line">    &lt;switch&gt;</span><br><span class="line">        &lt;case to=&quot;end&quot;&gt;</span><br><span class="line">            $&#123;wf:actionData(&apos;shell-node&apos;)[&apos;my_output&apos;] eq &apos;Hello Oozie&apos;&#125;</span><br><span class="line">        &lt;/case&gt;</span><br><span class="line">        &lt;default to=&quot;fail-output&quot;/&gt;</span><br><span class="line">    &lt;/switch&gt;</span><br><span class="line">&lt;/decision&gt;</span><br><span class="line">&lt;kill name=&quot;fail&quot;&gt;</span><br><span class="line">    &lt;message&gt;Shell action failed, error message[$&#123;wf:errorMessage(wf:lastErrorNode())&#125;]&lt;/message&gt;</span><br><span class="line">&lt;/kill&gt;</span><br><span class="line">&lt;kill name=&quot;fail-output&quot;&gt;</span><br><span class="line">    &lt;message&gt;Incorrect output, expected [Hello Oozie] but was [$&#123;wf:actionData(&apos;shell-node&apos;)[&apos;my_output&apos;]&#125;]&lt;/message&gt;</span><br><span class="line">&lt;/kill&gt;</span><br><span class="line">&lt;end name=&quot;end&quot;/&gt;</span><br><span class="line">&lt;/workflow-app&gt;</span><br></pre></td></tr></table></figure>

<p>job.properties配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">nameNode=hdfs://node01:8020</span><br><span class="line">jobTracker=node01:8032</span><br><span class="line">queueName=default</span><br><span class="line">examplesRoot=oozie_works</span><br><span class="line">EXEC=hello.sh</span><br><span class="line">outputDir=/oozie/output</span><br><span class="line">inputdir=/oozie/input</span><br><span class="line">jdbcURL=jdbc:hive2://node01:10000/default</span><br><span class="line">oozie.use.system.libpath=true</span><br><span class="line"># 配置我们文件上传到hdfs的保存路径 实际上就是在hdfs 的/user/root/oozie_works/sereval-actions这个路径下</span><br><span class="line">oozie.wf.application.path=$&#123;nameNode&#125;/user/$&#123;user.name&#125;/$&#123;examplesRoot&#125;/sereval-actions/workflow.xml</span><br></pre></td></tr></table></figure>

<p>4 上传任务调度到hdfs</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /export/servers/oozie-4.1.0-cdh5.14.0/oozie_works/</span><br><span class="line">hdfs dfs -put sereval-actions/ /user/root/oozie_works/</span><br></pre></td></tr></table></figure>

<p>5执行任务调度</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /export/servers/oozie-4.1.0-cdh5.14.0/</span><br><span class="line">bin/oozie job -oozie http://node01:11000/oozie -config oozie_works/sereval-actions/job.properties -run</span><br></pre></td></tr></table></figure>

<p>通过action节点 成功失败控制执行的流程</p>
<p>如果上一个action成功 跳转到下一个action 这样就可以变成首尾相连的串联任务</p>
<h2 id="5-定时调度"><a href="#5-定时调度" class="headerlink" title="5 定时调度"></a>5 定时调度</h2><p>在oozie当中，主要是通过Coordinator 来实现任务的定时调度， Coordinator 模块主要通过xml来进行配置即可。</p>
<p>Coordinator 的调度主要可以有两种实现方式</p>
<p>第一种：基于时间的定时任务调度：</p>
<p>oozie基于时间的调度主要需要指定三个参数，第一个起始时间，第二个结束时间，第三个调度频率；</p>
<p>第二种：基于数据的任务调度， 这种是基于数据的调度，只要在有了数据才会触发调度任务。</p>
<p>###1 准备配置模板</p>
<p>第一步：拷贝定时任务的调度模板</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /export/servers/oozie-4.1.0-cdh5.14.0</span><br><span class="line">cp -r examples/apps/cron oozie_works/cron-job</span><br></pre></td></tr></table></figure>

<p>第二步：拷贝我们的hello.sh脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /export/servers/oozie-4.1.0-cdh5.14.0/oozie_works</span><br><span class="line">cp shell/hello.sh  cron-job/</span><br></pre></td></tr></table></figure>

<h3 id="2修改配制模板"><a href="#2修改配制模板" class="headerlink" title="2修改配制模板"></a>2修改配制模板</h3><p>修改job.properties</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cd /export/servers/oozie-4.1.0-cdh5.14.0/oozie_works/cron-job</span><br><span class="line">vim job.properties</span><br><span class="line"></span><br><span class="line">nameNode=hdfs://node01:8020</span><br><span class="line">jobTracker=node01:8032</span><br><span class="line">queueName=default</span><br><span class="line">examplesRoot=oozie_works</span><br><span class="line"></span><br><span class="line">oozie.coord.application.path=$&#123;nameNode&#125;/user/$&#123;user.name&#125;/$&#123;examplesRoot&#125;/cron-job/coordinator.xml</span><br><span class="line">#start：必须设置为未来时间，否则任务失败</span><br><span class="line">start=2019-05-22T19:20+0800</span><br><span class="line">end=2019-08-22T19:20+0800</span><br><span class="line">EXEC=hello.sh</span><br><span class="line">workflowAppUri=$&#123;nameNode&#125;/user/$&#123;user.name&#125;/$&#123;examplesRoot&#125;/cron-job/workflow.xml</span><br></pre></td></tr></table></figure>

<p>修改coordinator.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">vim coordinator.xml</span><br><span class="line"></span><br><span class="line">&lt;!--</span><br><span class="line">	oozie的frequency 可以支持很多表达式，其中可以通过定时每分，或者每小时，或者每天，或者每月进行执行，也支持可以通过与linux的crontab表达式类似的写法来进行定时任务的执行</span><br><span class="line">	例如frequency 也可以写成以下方式</span><br><span class="line">	frequency=&quot;10 9 * * *&quot;  每天上午的09:10:00开始执行任务</span><br><span class="line">	frequency=&quot;0 1 * * *&quot;  每天凌晨的01:00开始执行任务</span><br><span class="line"> --&gt;</span><br><span class="line">&lt;coordinator-app name=&quot;cron-job&quot; frequency=&quot;$&#123;coord:minutes(1)&#125;&quot; start=&quot;$&#123;start&#125;&quot; end=&quot;$&#123;end&#125;&quot; timezone=&quot;GMT+0800&quot;</span><br><span class="line">                 xmlns=&quot;uri:oozie:coordinator:0.4&quot;&gt;</span><br><span class="line">        &lt;action&gt;</span><br><span class="line">        &lt;workflow&gt;</span><br><span class="line">            &lt;app-path&gt;$&#123;workflowAppUri&#125;&lt;/app-path&gt;</span><br><span class="line">            &lt;configuration&gt;</span><br><span class="line">                &lt;property&gt;</span><br><span class="line">                    &lt;name&gt;jobTracker&lt;/name&gt;</span><br><span class="line">                    &lt;value&gt;$&#123;jobTracker&#125;&lt;/value&gt;</span><br><span class="line">                &lt;/property&gt;</span><br><span class="line">                &lt;property&gt;</span><br><span class="line">                    &lt;name&gt;nameNode&lt;/name&gt;</span><br><span class="line">                    &lt;value&gt;$&#123;nameNode&#125;&lt;/value&gt;</span><br><span class="line">                &lt;/property&gt;</span><br><span class="line">                &lt;property&gt;</span><br><span class="line">                    &lt;name&gt;queueName&lt;/name&gt;</span><br><span class="line">                    &lt;value&gt;$&#123;queueName&#125;&lt;/value&gt;</span><br><span class="line">                &lt;/property&gt;</span><br><span class="line">            &lt;/configuration&gt;</span><br><span class="line">        &lt;/workflow&gt;</span><br><span class="line">    &lt;/action&gt;</span><br><span class="line">&lt;/coordinator-app&gt;</span><br></pre></td></tr></table></figure>

<p>修改workflow.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">vim workflow.xml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&lt;workflow-app xmlns=&quot;uri:oozie:workflow:0.5&quot; name=&quot;one-op-wf&quot;&gt;</span><br><span class="line">    &lt;start to=&quot;action1&quot;/&gt;</span><br><span class="line">    &lt;action name=&quot;action1&quot;&gt;</span><br><span class="line">    &lt;shell xmlns=&quot;uri:oozie:shell-action:0.2&quot;&gt;</span><br><span class="line">        &lt;job-tracker&gt;$&#123;jobTracker&#125;&lt;/job-tracker&gt;</span><br><span class="line">        &lt;name-node&gt;$&#123;nameNode&#125;&lt;/name-node&gt;</span><br><span class="line">        &lt;configuration&gt;</span><br><span class="line">            &lt;property&gt;</span><br><span class="line">                &lt;name&gt;mapred.job.queue.name&lt;/name&gt;</span><br><span class="line">                &lt;value&gt;$&#123;queueName&#125;&lt;/value&gt;</span><br><span class="line">            &lt;/property&gt;</span><br><span class="line">        &lt;/configuration&gt;</span><br><span class="line">        &lt;exec&gt;$&#123;EXEC&#125;&lt;/exec&gt;</span><br><span class="line">        &lt;!-- &lt;argument&gt;my_output=Hello Oozie&lt;/argument&gt; --&gt;</span><br><span class="line">        &lt;file&gt;/user/root/oozie_works/cron-job/$&#123;EXEC&#125;#$&#123;EXEC&#125;&lt;/file&gt;</span><br><span class="line"></span><br><span class="line">        &lt;capture-output/&gt;</span><br><span class="line">    &lt;/shell&gt;</span><br><span class="line">    &lt;ok to=&quot;end&quot;/&gt;</span><br><span class="line">    &lt;error to=&quot;end&quot;/&gt;</span><br><span class="line">&lt;/action&gt;</span><br><span class="line">    &lt;end name=&quot;end&quot;/&gt;</span><br><span class="line">&lt;/workflow-app&gt;</span><br></pre></td></tr></table></figure>

<h3 id="3上传调度任务到hdfs"><a href="#3上传调度任务到hdfs" class="headerlink" title="3上传调度任务到hdfs"></a>3上传调度任务到hdfs</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /export/servers/oozie-4.1.0-cdh5.14.0/oozie_works</span><br><span class="line">hdfs dfs -put cron-job/ /user/root/oozie_works/</span><br></pre></td></tr></table></figure>

<h3 id="4-执行调度"><a href="#4-执行调度" class="headerlink" title="4 执行调度"></a>4 执行调度</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /export/servers/oozie-4.1.0-cdh5.14.0</span><br><span class="line">bin/oozie job -oozie http://node01:11000/oozie -config oozie_works/cron-job/job.properties –run</span><br></pre></td></tr></table></figure>

<ul>
<li><p>oozie基于时间的定时</p>
<p>主要是需要coordinator来配合workflow进行周期性的触发执行</p>
<p>需要注意时间的格式问题 时区的问题</p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/08/08/Oozie/" data-id="cjz257yxu000gbcu5hjhov3df" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/08/08/Impala/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Impala
        
      </div>
    </a>
  
  
    <a href="/2019/08/08/Hue/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Hue</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/08/08/Hive/">Hive</a>
          </li>
        
          <li>
            <a href="/2019/08/08/Flume/">Flume</a>
          </li>
        
          <li>
            <a href="/2019/08/08/Sqoop/">Sqoop</a>
          </li>
        
          <li>
            <a href="/2019/08/08/Azkaban/">Azkaban</a>
          </li>
        
          <li>
            <a href="/2019/08/08/Impala/">Impala</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>