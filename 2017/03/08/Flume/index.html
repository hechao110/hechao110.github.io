<!DOCTYPE html><html lang="hc-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="一只沙皮狗的悲伤"><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style-dark.css?v=2.0.4"><link rel="stylesheet" type="text/css" href="/css/highlight-dark.css?v=2.0.4"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><title>Flume | 一只沙皮狗的悲伤</title></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Flume</h1><a id="logo" href="/.">一只沙皮狗的悲伤</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Start</i></a><a href="/archives/"><i class="fa fa-archive"> Archiv</i></a><a href="/about/"><i class="fa fa-user"> Über</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Suche"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">Flume</h1><div class="post-meta"><a href="/2017/03/08/Flume/#comments" class="comment-count"></a><p><span class="date">Mar 08, 2017</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>Schlägt</i></i></span></p></div><div class="post-content"><p>Apache Flume</p>
<h1 id="一-概述"><a href="#一-概述" class="headerlink" title="一 概述"></a>一 概述</h1><p> flume是一个高可用,高可靠的,分布式的海量日志采集,聚合和传输的软件.特别指的是数据流转的过程，或者说是数据搬运的过程。把数据从一个存储介质通过flume传递到另一个存储介质中。</p>
<p> 核心是把数据从数据源(source)收集过来,再将收集的数据送到指定的目的地(sink).为保证一定能送到目的地,再送到目的地之前,会先缓存数据(channel),等到数据到达目的地后,flume删除缓存.</p>
<p> flume支持定义各类数据发送方,用于收集各种类型数据,同时，Flume支持定制各种数据接受方，用于最终存储数据。一般的采集需求，通过对flume的简单配置即可实现。针对特殊场景也具备良好的自定义扩展能力。因此，flume可以适用于大部分的日常数据采集场景。</p>
<h1 id="二-运行机制"><a href="#二-运行机制" class="headerlink" title="二 运行机制"></a>二 运行机制</h1><p><a href="https://manzhong.github.io/images/flume/flume%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6.png" target="_blank" rel="noopener"><img src="https://manzhong.github.io/images/flume/flume%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6.png" alt="img"></a></p>
<p> 1 核心组件</p>
<ul>
<li><p>source ：用于对接各个不同的数据源</p>
</li>
<li><p>sink：用于对接各个不同存储数据的目的地（数据下沉地）</p>
</li>
<li><p>channel：用于中间临时存储缓存数据</p>
<p>2 机制</p>
</li>
<li><p>flume本身是java程序 在需要采集数据机器上启动 —–&gt;agent进程</p>
</li>
<li><p>agent进程里面包含了：source sink channel</p>
</li>
<li><p>在flume中，数据被包装成event 真是的数据是放在event body中<br>event是flume中最小的数据单元</p>
<p>3 架构</p>
</li>
<li><p>简单架构</p>
<p>只需要部署一个agent进程即可</p>
<p><a href="https://manzhong.github.io/images/flume/%E7%AE%80%E5%8D%95%E6%9E%B6%E6%9E%84.png" target="_blank" rel="noopener"><img src="https://manzhong.github.io/images/flume/%E7%AE%80%E5%8D%95%E6%9E%B6%E6%9E%84.png" alt="img"></a></p>
</li>
<li><p>复杂架构</p>
<p>多个agent之间的串联 相当于大家手拉手共同完成数据的采集传输工作</p>
<p>在串联的架构中没有主从之分 大家的地位都是一样的</p>
</li>
</ul>
<p><a href="https://manzhong.github.io/images/flume/%E5%A4%8D%E6%9D%82%E6%9E%B6%E6%9E%84.png" target="_blank" rel="noopener"><img src="https://manzhong.github.io/images/flume/%E5%A4%8D%E6%9D%82%E6%9E%B6%E6%9E%84.png" alt="img"></a></p>
<h1 id="三-安装部署"><a href="#三-安装部署" class="headerlink" title="三 安装部署"></a>三 安装部署</h1><p> 上传安装包到数据源所在节点上然后解压 tar -zxvf apache-flume-1.8.0-bin.tar.gz然后进入flume的目录，修改conf下的flume-env.sh，在里面配置JAVA_HOME</p>
<p>flume开发步骤</p>
<p>在conf中,就是根据业务需求编写采集方案配置文件</p>
<ul>
<li>文件名见名知意 通常以souce——sink.conf</li>
<li>具体需要描述清楚sink source channel组件配置信息 结合官网配置</li>
</ul>
<p>启动命令:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bin/flume-ng agent --conf conf --conf-file conf/netcat-logger.conf --name a1 -Dflume.root.logger=INFO,console  命令完整版</span><br><span class="line">bin/flume-ng agent -c ./conf -f ./conf/spool-hdfs.conf -n a1 -Dflume.root.logger=INFO,console  命令精简版</span><br><span class="line">--conf指定配置文件的目录</span><br><span class="line">--conf-file指定采集方案路径</span><br><span class="line">--name  agent进程名字 要跟采集方案中保持一致</span><br></pre></td></tr></table></figure>

<h1 id="四-测试环境"><a href="#四-测试环境" class="headerlink" title="四 测试环境:"></a>四 测试环境:</h1><p>在conf目录下配置:vi netcat-logger.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 定义这个agent中各组件的名字</span><br><span class="line">a1.sources = r1</span><br><span class="line">a1.sinks = k1</span><br><span class="line">a1.channels = c1</span><br><span class="line"></span><br><span class="line"># 描述和配置source组件：r1</span><br><span class="line">a1.sources.r1.type = netcat</span><br><span class="line">a1.sources.r1.bind = localhost</span><br><span class="line">a1.sources.r1.port = 44444</span><br><span class="line"></span><br><span class="line"># 描述和配置sink组件：k1</span><br><span class="line">a1.sinks.k1.type = logger</span><br><span class="line"></span><br><span class="line"># 描述和配置channel组件，此处使用是内存缓存的方式</span><br><span class="line">a1.channels.c1.type = memory</span><br><span class="line">a1.channels.c1.capacity = 1000</span><br><span class="line">a1.channels.c1.transactionCapacity = 100</span><br><span class="line"></span><br><span class="line"># 描述和配置source  channel   sink之间的连接关系</span><br><span class="line">a1.sources.r1.channels = c1</span><br><span class="line">a1.sinks.k1.channel = c1</span><br></pre></td></tr></table></figure>

<p>启动agent去采集数据:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/flume-ng agent --conf conf --conf-file conf/netcat-logger.conf --name a1 -Dflume.root.logger=INFO,console</span><br></pre></td></tr></table></figure>

<p>测试:</p>
<p>先要往agent采集监听的端口上发送数据，让agent有数据可采。</p>
<p>随便在一个能跟agent节点联网的机器上：</p>
<p>telnetanget-hostname port （telnet localhost 44444）</p>
<h1 id="五-采集目录到hdfs"><a href="#五-采集目录到hdfs" class="headerlink" title="五 采集目录到hdfs:"></a>五 采集目录到hdfs:</h1><p>需求:<strong>服务器的某特定目录下，会不断产生新的文件，每当有新文件出现，就需要把文件采集到HDFS中去</strong></p>
<p>l 采集源，即source——监控文件目录 : <strong>spooldir</strong></p>
<p>l 下沉目标，即sink——HDFS文件系统 : <strong>hdfs sink</strong></p>
<p>l source和sink之间的传递通道——channel，可用file channel 也可以用内存channel</p>
<p>编写配置文件:vim spooldir-hdfs.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"># Name the components on this agent</span><br><span class="line">a1.sources = r1</span><br><span class="line">a1.sinks = k1</span><br><span class="line">a1.channels = c1</span><br><span class="line"></span><br><span class="line"># Describe/configure the source</span><br><span class="line">##注意：不能往监控目中重复丢同名文件</span><br><span class="line">a1.sources.r1.type = spooldir</span><br><span class="line">a1.sources.r1.spoolDir = /root/logs</span><br><span class="line">a1.sources.r1.fileHeader = true</span><br><span class="line"></span><br><span class="line"># Describe the sink 目的地</span><br><span class="line">a1.sinks.k1.type = hdfs</span><br><span class="line">a1.sinks.k1.hdfs.path = /flume/events/%y-%m-%d/%H%M/</span><br><span class="line">a1.sinks.k1.hdfs.filePrefix = events-</span><br><span class="line">a1.sinks.k1.hdfs.round = true</span><br><span class="line">a1.sinks.k1.hdfs.roundValue = 10</span><br><span class="line">a1.sinks.k1.hdfs.roundUnit = minute</span><br><span class="line">a1.sinks.k1.hdfs.rollInterval = 3</span><br><span class="line">a1.sinks.k1.hdfs.rollSize = 20</span><br><span class="line">a1.sinks.k1.hdfs.rollCount = 5</span><br><span class="line">a1.sinks.k1.hdfs.batchSize = 1</span><br><span class="line">a1.sinks.k1.hdfs.useLocalTimeStamp = true</span><br><span class="line">#生成的文件类型，默认是Sequencefile，可用DataStream，则为普通文本</span><br><span class="line">a1.sinks.k1.hdfs.fileType = DataStream</span><br><span class="line"></span><br><span class="line"># Use a channel which buffers events in memory </span><br><span class="line">a1.channels.c1.type = memory</span><br><span class="line">a1.channels.c1.capacity = 1000</span><br><span class="line">a1.channels.c1.transactionCapacity = 100</span><br><span class="line"></span><br><span class="line"># Bind the source and sink to the channel</span><br><span class="line">a1.sources.r1.channels = c1</span><br><span class="line">a1.sinks.k1.channel = c1</span><br></pre></td></tr></table></figure>

<p>参数解释(sink):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">roll控制写入hdfs文件 以何种方式进行滚动</span><br><span class="line">a1.sinks.k1.hdfs.rollInterval = 3  以时间间隔</span><br><span class="line">a1.sinks.k1.hdfs.rollSize = 20     以文件大小</span><br><span class="line">a1.sinks.k1.hdfs.rollCount = 5     </span><br><span class="line">以event个数如果三个都配置  谁先满足谁触发滚动如果不想以某种属性滚动  设置为0即可</span><br><span class="line"></span><br><span class="line">是否开启时间上的舍弃  控制文件夹以多少时间间隔滚动</span><br><span class="line">以下述为例：就会每10分钟生成一个文件夹</span><br><span class="line">a1.sinks.k1.hdfs.round = true</span><br><span class="line">a1.sinks.k1.hdfs.roundValue = 10</span><br><span class="line">a1.sinks.k1.hdfs.roundUnit = minute</span><br></pre></td></tr></table></figure>

<p>Channel参数解释：</p>
<p>capacity：默认该通道中最大的可以存储的event数量</p>
<p>trasactionCapacity：每次最大可以从source中拿到或者送到sink中的event数量</p>
<p>注意:</p>
<ul>
<li>注意其监控的文件夹下面不能有同名文件的产生</li>
<li>如果有 报错且罢工 后续就不再进行数据的监视采集了</li>
<li>在企业中通常给文件追加时间戳命名的方式保证文件不会重名</li>
</ul>
<p>启动同上:</p>
<p>测试 :往源目录里存入文件</p>
<h1 id="六-采集文件到HDFS"><a href="#六-采集文件到HDFS" class="headerlink" title="六 采集文件到HDFS"></a>六 采集文件到HDFS</h1><p>需求:比如业务系统使用log4j生成的日志，日志内容不断增加，需要把追加到日志文件中的数据实时采集到hdfs</p>
<p>l 采集源，即source——监控文件内容更新 : exec ‘tail-F file’</p>
<p>l 下沉目标，即sink——HDFS文件系统 : hdfssink</p>
<p>l Source和sink之间的传递通道——channel，可用file channel 也可以用 内存channel</p>
<p>编写配置文件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># Name the components on this agent</span><br><span class="line">a1.sources = r1</span><br><span class="line">a1.sinks = k1</span><br><span class="line">a1.channels = c1</span><br><span class="line"></span><br><span class="line"># Describe/configure the source</span><br><span class="line">a1.sources.r1.type = exec</span><br><span class="line">a1.sources.r1.command = tail -F /root/logs/test.log</span><br><span class="line">a1.sources.r1.channels = c1</span><br><span class="line"></span><br><span class="line"># Describe the sink</span><br><span class="line">a1.sinks.k1.type = hdfs</span><br><span class="line">a1.sinks.k1.hdfs.path = /flume/tailout/%y-%m-%d/%H%M/</span><br><span class="line">a1.sinks.k1.hdfs.filePrefix = events-</span><br><span class="line">a1.sinks.k1.hdfs.round = true</span><br><span class="line">a1.sinks.k1.hdfs.roundValue = 10</span><br><span class="line">a1.sinks.k1.hdfs.roundUnit = minute</span><br><span class="line">a1.sinks.k1.hdfs.rollInterval = 3</span><br><span class="line">a1.sinks.k1.hdfs.rollSize = 20</span><br><span class="line">a1.sinks.k1.hdfs.rollCount = 5</span><br><span class="line">a1.sinks.k1.hdfs.batchSize = 1</span><br><span class="line">a1.sinks.k1.hdfs.useLocalTimeStamp = true</span><br><span class="line">#生成的文件类型，默认是Sequencefile，可用DataStream，则为普通文本</span><br><span class="line">a1.sinks.k1.hdfs.fileType = DataStream</span><br><span class="line"></span><br><span class="line"># Use a channel which buffers events in memory</span><br><span class="line">a1.channels.c1.type = memory</span><br><span class="line">a1.channels.c1.capacity = 1000</span><br><span class="line">a1.channels.c1.transactionCapacity = 100</span><br><span class="line"></span><br><span class="line"># Bind the source and sink to the channel</span><br><span class="line">a1.sources.r1.channels = c1</span><br><span class="line">a1.sinks.k1.channel = c1</span><br></pre></td></tr></table></figure>

<p>参数解析:</p>
<p>· rollInterval</p>
<p>默认值：30</p>
<p>hdfssink间隔多长将临时文件滚动成最终目标文件，单位：秒；</p>
<p>如果设置成0，则表示不根据时间来滚动文件；</p>
<p>注：滚动（roll）指的是，hdfs sink将临时文件重命名成最终目标文件，并新打开一个临时文件来写入数据；</p>
<p>· <strong>rollSize\</strong>****</p>
<p>默认值：1024</p>
<p>当临时文件达到该大小（单位：bytes）时，滚动成目标文件；</p>
<p>如果设置成0，则表示不根据临时文件大小来滚动文件；</p>
<p>· <strong>rollCount\</strong>****</p>
<p>默认值：10</p>
<p>当events数据达到该数量时候，将临时文件滚动成目标文件；</p>
<p>如果设置成0，则表示不根据events数据来滚动文件；</p>
<p>· <strong>round\</strong>****</p>
<p>默认值：false</p>
<p>是否启用时间上的“舍弃”，这里的“舍弃”，类似于“四舍五入”。</p>
<p>· <strong>roundValue\</strong>****</p>
<p>默认值：1</p>
<p>时间上进行“舍弃”的值；</p>
<p>· <strong>roundUnit\</strong>****</p>
<p>默认值：seconds</p>
<p>时间上进行“舍弃”的单位，包含：second,minute,hour</p>
<p>示例：</p>
<p>a1.sinks.k1.hdfs.path= /flume/events/%y-%m-%d/%H%M/%S</p>
<p>a1.sinks.k1.hdfs.round= true</p>
<p>a1.sinks.k1.hdfs.roundValue= 10</p>
<p>a1.sinks.k1.hdfs.roundUnit= minute</p>
<p>当时间为2015-10-16 17:38:59时候，hdfs.path依然会被解析为：</p>
<p>/flume/events/20151016/17:30/00</p>
<p>因为设置的是舍弃10分钟内的时间，因此，该目录每10分钟新生成一个。</p>
<p>启动同上:</p>
<p>测试:exec source 可以执行指定的linux command 把命令的结果作为数据进行收集</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">while true; do date &gt;&gt; /root/logs/test.log;done</span><br><span class="line">使用该脚本模拟数据实时变化的过程</span><br></pre></td></tr></table></figure>

<h1 id="七-Flume的load-balance、failover"><a href="#七-Flume的load-balance、failover" class="headerlink" title="七 Flume的load-balance、failover"></a>七 Flume的load-balance、failover</h1><h2 id="1-负载均衡"><a href="#1-负载均衡" class="headerlink" title="1 负载均衡"></a>1 负载均衡</h2><ul>
<li>所谓的负载均衡 用于解决一个进程或者程序处理不了所有请求 多个进程一起处理的场景</li>
<li>同一个请求只能交给一个进行处理 避免数据重复</li>
<li>如何分配请求就涉及到了负载均衡的算法：轮询（round_robin） 随机（random） 权重</li>
</ul>
<p><a href="https://manzhong.github.io/images/flume/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1.png" target="_blank" rel="noopener"><img src="https://manzhong.github.io/images/flume/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1.png" alt="img"></a></p>
<p>例如三节点配置:</p>
<p>主节点:vim exec-avro.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">#agent1 name</span><br><span class="line">agent1.channels = c1</span><br><span class="line">agent1.sources = r1</span><br><span class="line">agent1.sinks = k1 k2</span><br><span class="line"></span><br><span class="line">#set gruop</span><br><span class="line">agent1.sinkgroups = g1</span><br><span class="line"></span><br><span class="line">#set channel</span><br><span class="line">agent1.channels.c1.type = memory</span><br><span class="line">agent1.channels.c1.capacity = 1000</span><br><span class="line">agent1.channels.c1.transactionCapacity = 100</span><br><span class="line"></span><br><span class="line"># set sources</span><br><span class="line">agent1.sources.r1.channels = c1</span><br><span class="line">agent1.sources.r1.type = exec</span><br><span class="line">agent1.sources.r1.command = tail -F /root/logs/123.log</span><br><span class="line"></span><br><span class="line"># set sink1</span><br><span class="line">agent1.sinks.k1.channel = c1</span><br><span class="line">agent1.sinks.k1.type = avro</span><br><span class="line">agent1.sinks.k1.hostname = node02</span><br><span class="line">agent1.sinks.k1.port = 52020</span><br><span class="line"></span><br><span class="line"># set sink2</span><br><span class="line">agent1.sinks.k2.channel = c1</span><br><span class="line">agent1.sinks.k2.type = avro</span><br><span class="line">agent1.sinks.k2.hostname = node03</span><br><span class="line">agent1.sinks.k2.port = 52020</span><br><span class="line"></span><br><span class="line">#set sink group</span><br><span class="line">agent1.sinkgroups.g1.sinks = k1 k2</span><br><span class="line"></span><br><span class="line">#set failover</span><br><span class="line">agent1.sinkgroups.g1.processor.type = load_balance</span><br><span class="line">agent1.sinkgroups.g1.processor.backoff = true  #如果开启，则将失败的sink放入黑名单</span><br><span class="line"># round_robin 轮询  还支持random 随机</span><br><span class="line">agent1.sinkgroups.g1.processor.selector = round_robin </span><br><span class="line">agent1.sinkgroups.g1.processor.selector.maxTimeOut=10000 #在黑名单放置的超时时间，超时结束时，若仍然无法接收，则超时时间呈指数增长</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#启动</span><br><span class="line">bin/flume-ng agent -c conf -f conf/exec-avro.conf -n agent1 -Dflume.root.logger=INFO,console</span><br></pre></td></tr></table></figure>

<p>第二节点:vim avro-logger.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># Name the components on this agent</span><br><span class="line">a1.sources = r1</span><br><span class="line">a1.sinks = k1</span><br><span class="line">a1.channels = c1</span><br><span class="line"></span><br><span class="line"># Describe/configure the source</span><br><span class="line">a1.sources.r1.type = avro</span><br><span class="line">a1.sources.r1.channels = c1</span><br><span class="line">a1.sources.r1.bind = node02</span><br><span class="line">a1.sources.r1.port = 52020</span><br><span class="line"></span><br><span class="line"># Describe the sink</span><br><span class="line">a1.sinks.k1.type = logger</span><br><span class="line"></span><br><span class="line"># Use a channel which buffers events in memory</span><br><span class="line">a1.channels.c1.type = memory</span><br><span class="line">a1.channels.c1.capacity = 1000</span><br><span class="line">a1.channels.c1.transactionCapacity = 100</span><br><span class="line"></span><br><span class="line"># Bind the source and sink to the channel</span><br><span class="line">a1.sources.r1.channels = c1</span><br><span class="line">a1.sinks.k1.channel = c1</span><br><span class="line"></span><br><span class="line">#启动bin/flume-ng agent -c conf -f conf/avro-logger.conf -n a1 -Dflume.root.logger=INFO,console</span><br></pre></td></tr></table></figure>

<p>第三节点:vim avro-logger.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># Name the components on this agent</span><br><span class="line">a1.sources = r1</span><br><span class="line">a1.sinks = k1</span><br><span class="line">a1.channels = c1</span><br><span class="line"></span><br><span class="line"># Describe/configure the source</span><br><span class="line">a1.sources.r1.type = avro</span><br><span class="line">a1.sources.r1.channels = c1</span><br><span class="line">a1.sources.r1.bind = node03</span><br><span class="line">a1.sources.r1.port = 52020</span><br><span class="line"></span><br><span class="line"># Describe the sink</span><br><span class="line">a1.sinks.k1.type = logger</span><br><span class="line"></span><br><span class="line"># Use a channel which buffers events in memory</span><br><span class="line">a1.channels.c1.type = memory</span><br><span class="line">a1.channels.c1.capacity = 1000</span><br><span class="line">a1.channels.c1.transactionCapacity = 100</span><br><span class="line"></span><br><span class="line"># Bind the source and sink to the channel</span><br><span class="line">a1.sources.r1.channels = c1</span><br><span class="line">a1.sinks.k1.channel = c1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#启动</span><br><span class="line">bin/flume-ng agent -c conf -f conf/avro-logger.conf -n a1 -Dflume.root.logger=INFO,console</span><br></pre></td></tr></table></figure>

<p>flume串联跨网络传输数据</p>
<ul>
<li><p>avro sink</p>
</li>
<li><p>avro source</p>
<p>使用上述两个组件指定绑定的端口ip 就可以满足数据跨网络的传递 通常用于flume串联架构中</p>
</li>
<li><p>flume串联启动</p>
<p>通常从远离数据源的那一级开始启动</p>
</li>
</ul>
<h2 id="2-flume-failover"><a href="#2-flume-failover" class="headerlink" title="2 flume failover"></a>2 flume failover</h2><ul>
<li>容错又称之为故障转移 容忍错误的发生。</li>
<li>通常用于解决单点故障 给容易出故障的地方设置备份</li>
<li>备份越多 容错能力越强 但是资源的浪费越严重</li>
</ul>
<p>具体流程类似loadbalance，但是内部处理机制与load balance完全不同。</p>
<p> Failover Sink Processor维护一个优先级Sink组件列表，只要有一个Sink组件可用，Event就被传递到下一个组件。故障转移机制的作用是将失败的Sink降级到一个池，在这些池中它们被分配一个冷却时间，随着故障的连续，在重试之前冷却时间增加。一旦Sink成功发送一个事件，它将恢复到活动池。 Sink具有与之相关的优先级，数量越大，优先级越高。</p>
<p> 例如，具有优先级为100的sink在优先级为80的Sink之前被激活。如果在发送事件时汇聚失败，则接下来将尝试下一个具有最高优先级的Sink发送事件。如果没有指定优先级，则根据在配置中指定Sink的顺序来确定优先级。</p>
<p>主节点: vim exec-avro.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">#agent1 name</span><br><span class="line">agent1.channels = c1</span><br><span class="line">agent1.sources = r1</span><br><span class="line">agent1.sinks = k1 k2</span><br><span class="line"></span><br><span class="line">#set gruop</span><br><span class="line">agent1.sinkgroups = g1</span><br><span class="line"></span><br><span class="line">#set channel</span><br><span class="line">agent1.channels.c1.type = memory</span><br><span class="line">agent1.channels.c1.capacity = 1000</span><br><span class="line">agent1.channels.c1.transactionCapacity = 100</span><br><span class="line"></span><br><span class="line"># set sources</span><br><span class="line">agent1.sources.r1.channels = c1</span><br><span class="line">agent1.sources.r1.type = exec</span><br><span class="line">agent1.sources.r1.command = tail -F /root/logs/456.log</span><br><span class="line"></span><br><span class="line"># set sink1</span><br><span class="line">agent1.sinks.k1.channel = c1</span><br><span class="line">agent1.sinks.k1.type = avro</span><br><span class="line">agent1.sinks.k1.hostname = node02</span><br><span class="line">agent1.sinks.k1.port = 52020</span><br><span class="line"></span><br><span class="line"># set sink2</span><br><span class="line">agent1.sinks.k2.channel = c1</span><br><span class="line">agent1.sinks.k2.type = avro</span><br><span class="line">agent1.sinks.k2.hostname = node03</span><br><span class="line">agent1.sinks.k2.port = 52020</span><br><span class="line"></span><br><span class="line">#set sink group</span><br><span class="line">agent1.sinkgroups.g1.sinks = k1 k2</span><br><span class="line"></span><br><span class="line">#set failover</span><br><span class="line">agent1.sinkgroups.g1.processor.type = failover</span><br><span class="line">agent1.sinkgroups.g1.processor.priority.k1 = 10  #优先级值, 绝对值越大表示优先级越高</span><br><span class="line">agent1.sinkgroups.g1.processor.priority.k2 = 1</span><br><span class="line">agent1.sinkgroups.g1.processor.maxpenalty = 10000  #失败的Sink的最大回退期（millis）</span><br><span class="line"></span><br><span class="line">#启动</span><br><span class="line">bin/flume-ng agent -c conf -f conf/exec-avro.conf -n agent1 -Dflume.root.logger=INFO,console</span><br></pre></td></tr></table></figure>

<p>第二节点与第三节点配置 同load-balance的</p>
<h1 id="八-flume拦截器"><a href="#八-flume拦截器" class="headerlink" title="八 flume拦截器"></a>八 flume拦截器</h1><h2 id="1-静态拦截器-日志的采集与汇总"><a href="#1-静态拦截器-日志的采集与汇总" class="headerlink" title="1 静态拦截器 日志的采集与汇总"></a>1 静态拦截器 日志的采集与汇总</h2><p>需求:</p>
<p>A、B两台日志服务机器实时生产日志主要类型为access.log、nginx.log、web.log</p>
<p>把A、B 机器中的access.log、nginx.log、web.log 采集汇总到C机器上然后统一收集到hdfs中</p>
<p>数据流程处理分析:</p>
<p><a href="https://manzhong.github.io/images/flume/flume%E6%8B%A6%E6%88%AA%E5%99%A8%E5%A4%84%E7%90%86%E6%9C%BA%E5%88%B6.png" target="_blank" rel="noopener"><img src="https://manzhong.github.io/images/flume/flume%E6%8B%A6%E6%88%AA%E5%99%A8%E5%A4%84%E7%90%86%E6%9C%BA%E5%88%B6.png" alt="img"></a></p>
<p>在第一台节点上配置 vim exec_source_avro_sink.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"># Name the components on this agent </span><br><span class="line">a1.sources = r1 r2 r3</span><br><span class="line">a1.sinks = k1</span><br><span class="line">a1.channels = c1</span><br><span class="line"></span><br><span class="line"># Describe/configure the source</span><br><span class="line">a1.sources.r1.type = exec</span><br><span class="line">a1.sources.r1.command = tail -F /root/logs/access.log</span><br><span class="line">a1.sources.r1.interceptors = i1</span><br><span class="line">a1.sources.r1.interceptors.i1.type = static</span><br><span class="line">a1.sources.r1.interceptors.i1.key = type</span><br><span class="line">a1.sources.r1.interceptors.i1.value = access</span><br><span class="line"></span><br><span class="line">a1.sources.r2.type = exec</span><br><span class="line">a1.sources.r2.command = tail -F /root/logs/nginx.log</span><br><span class="line">a1.sources.r2.interceptors = i2</span><br><span class="line">a1.sources.r2.interceptors.i2.type = static</span><br><span class="line">a1.sources.r2.interceptors.i2.key = type</span><br><span class="line">a1.sources.r2.interceptors.i2.value = nginx</span><br><span class="line"></span><br><span class="line">a1.sources.r3.type = exec</span><br><span class="line">a1.sources.r3.command = tail -F /root/logs/web.log</span><br><span class="line">a1.sources.r3.interceptors = i3</span><br><span class="line">a1.sources.r3.interceptors.i3.type = static</span><br><span class="line">a1.sources.r3.interceptors.i3.key = type</span><br><span class="line">a1.sources.r3.interceptors.i3.value = web</span><br><span class="line"></span><br><span class="line"># Describe the sink</span><br><span class="line">a1.sinks.k1.type = avro</span><br><span class="line">a1.sinks.k1.hostname = node02</span><br><span class="line">a1.sinks.k1.port = 41414</span><br><span class="line"></span><br><span class="line"># Use a channel which buffers events in memory</span><br><span class="line">a1.channels.c1.type = memory</span><br><span class="line">a1.channels.c1.capacity = 2000</span><br><span class="line">a1.channels.c1.transactionCapacity = 100</span><br><span class="line"></span><br><span class="line"># Bind the source and sink to the channel</span><br><span class="line">a1.sources.r1.channels = c1</span><br><span class="line">a1.sources.r2.channels = c1</span><br><span class="line">a1.sources.r3.channels = c1</span><br><span class="line">a1.sinks.k1.channel = c1</span><br></pre></td></tr></table></figure>

<p>在第三台上配置vim avro_source_hdfs_sink.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">#定义agent名， source、channel、sink的名称</span><br><span class="line">a1.sources = r1</span><br><span class="line">a1.sinks = k1</span><br><span class="line">a1.channels = c1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#定义source</span><br><span class="line">a1.sources.r1.type = avro</span><br><span class="line">a1.sources.r1.bind = node02</span><br><span class="line">a1.sources.r1.port =41414</span><br><span class="line"></span><br><span class="line">#添加时间拦截器</span><br><span class="line">a1.sources.r1.interceptors = i1</span><br><span class="line">a1.sources.r1.interceptors.i1.type = org.apache.flume.interceptor.TimestampInterceptor$Builder</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#定义channels</span><br><span class="line">a1.channels.c1.type = memory</span><br><span class="line">a1.channels.c1.capacity = 20000</span><br><span class="line">a1.channels.c1.transactionCapacity = 10000</span><br><span class="line"></span><br><span class="line">#定义sink</span><br><span class="line">a1.sinks.k1.type = hdfs</span><br><span class="line">a1.sinks.k1.hdfs.path=hdfs://node01:9000/source/logs/%&#123;type&#125;/%Y%m%d</span><br><span class="line">a1.sinks.k1.hdfs.filePrefix =events</span><br><span class="line">a1.sinks.k1.hdfs.fileType = DataStream</span><br><span class="line">a1.sinks.k1.hdfs.writeFormat = Text</span><br><span class="line">#时间类型</span><br><span class="line">#a1.sinks.k1.hdfs.useLocalTimeStamp = true</span><br><span class="line">#生成的文件不按条数生成</span><br><span class="line">a1.sinks.k1.hdfs.rollCount = 0</span><br><span class="line">#生成的文件不按时间生成</span><br><span class="line">a1.sinks.k1.hdfs.rollInterval = 20</span><br><span class="line">#生成的文件按大小生成</span><br><span class="line">a1.sinks.k1.hdfs.rollSize  = 10485760</span><br><span class="line">#批量写入hdfs的个数</span><br><span class="line">a1.sinks.k1.hdfs.batchSize = 20</span><br><span class="line">flume操作hdfs的线程数（包括新建，写入等）</span><br><span class="line">a1.sinks.k1.hdfs.threadsPoolSize=10</span><br><span class="line">#操作hdfs超时时间</span><br><span class="line">a1.sinks.k1.hdfs.callTimeout=30000</span><br><span class="line"></span><br><span class="line">#组装source、channel、sink</span><br><span class="line">a1.sources.r1.channels = c1</span><br><span class="line">a1.sinks.k1.channel = c1</span><br></pre></td></tr></table></figure>

<p>使用静态拦截器前后对比:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">如果没有使用静态拦截器</span><br><span class="line">Event: &#123; headers:&#123;&#125; body:  36 Sun Jun  2 18:26 &#125;</span><br><span class="line"></span><br><span class="line">使用静态拦截器之后 自己添加kv标识对</span><br><span class="line">Event: &#123; headers:&#123;type=access&#125; body:  36 Sun Jun  2 18:26 &#125;</span><br><span class="line">Event: &#123; headers:&#123;type=nginx&#125; body:  36 Sun Jun  2 18:26 &#125;</span><br><span class="line">Event: &#123; headers:&#123;type=web&#125; body:  36 Sun Jun  2 18:26 &#125;</span><br></pre></td></tr></table></figure>

<p>后续在存放数据的时候可以使用flume的规则语法获取到拦截器添加的kv内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%&#123;type&#125;</span><br></pre></td></tr></table></figure>

<p>模拟数据实时产生:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">while true; do echo &quot;access access.....&quot; &gt;&gt; /root/logs/access.log;sleep 0.5;done</span><br><span class="line">while true; do echo &quot;web web.....&quot; &gt;&gt; /root/logs/web.log;sleep 0.5;done</span><br><span class="line">while true; do echo &quot;nginx nginx.....&quot; &gt;&gt; /root/logs/nginx.log;sleep 0.5;done</span><br></pre></td></tr></table></figure>

<p>配置完成后:</p>
<p>配置完成之后，在服务器A上的/root/data有数据文件access.log、nginx.log、web.log。</p>
<p>先启动服务器C上的flume，启动命令在flume安装目录下执行 ：</p>
<p>bin/flume-ng agent -c conf -f conf/avro_source_hdfs_sink.conf -name a1 -Dflume.root.logger=DEBUG,console</p>
<p>然后在启动服务器上的A，启动命令</p>
<p>在flume安装目录下执行 ：</p>
<p>bin/flume-ng agent -c conf -f conf/exec_source_avro_sink.conf -name a1 -Dflume.root.logger=DEBUG,console</p>
<h2 id="2-自定义拦截器"><a href="#2-自定义拦截器" class="headerlink" title="2 自定义拦截器"></a>2 自定义拦截器</h2><p>拦截器简介:</p>
<p> Flume有各种自带的拦截器，比如：TimestampInterceptor、HostInterceptor、RegexExtractorInterceptor等，通过使用不同的拦截器，实现不同的功能。但是以上的这些拦截器，不能改变原有日志数据的内容或者对日志信息添加一定的处理逻辑，当一条日志信息有几十个甚至上百个字段的时候，在传统的Flume处理下，收集到的日志还是会有对应这么多的字段，也不能对你想要的字段进行对应的处理。</p>
<p>自定义拦截器:</p>
<p>根据实际业务的需求，为了更好的满足数据在应用层的处理，通过自定义Flume拦截器，过滤掉不需要的字段，并对指定字段加密处理，将源数据进行预处理。减少了数据的传输量，降低了存储的开销.</p>
<p>分为两部分;</p>
<p>1 编写java代码,自定义拦截器</p>
<p>pom.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;</span><br><span class="line">         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;groupId&gt;cn.baidu.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;example-flume-intercepter&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.flume&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;flume-ng-sdk&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.8.0&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.flume&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;flume-ng-core&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.8.0&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;3.0&lt;/version&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;source&gt;1.8&lt;/source&gt;</span><br><span class="line">                    &lt;target&gt;1.8&lt;/target&gt;</span><br><span class="line">                    &lt;encoding&gt;UTF-8&lt;/encoding&gt;</span><br><span class="line">                    &lt;!--    &lt;verbal&gt;true&lt;/verbal&gt;--&gt;</span><br><span class="line">                &lt;/configuration&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;maven-shade-plugin&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;3.1.1&lt;/version&gt;</span><br><span class="line">                &lt;executions&gt;</span><br><span class="line">                    &lt;execution&gt;</span><br><span class="line">                        &lt;phase&gt;package&lt;/phase&gt;</span><br><span class="line">                        &lt;goals&gt;</span><br><span class="line">                            &lt;goal&gt;shade&lt;/goal&gt;</span><br><span class="line">                        &lt;/goals&gt;</span><br><span class="line">                        &lt;configuration&gt;</span><br><span class="line">                            &lt;filters&gt;</span><br><span class="line">                                &lt;filter&gt;</span><br><span class="line">                                    &lt;artifact&gt;*:*&lt;/artifact&gt;</span><br><span class="line">                                    &lt;excludes&gt;</span><br><span class="line">                                        &lt;exclude&gt;META-INF/*.SF&lt;/exclude&gt;</span><br><span class="line">                                        &lt;exclude&gt;META-INF/*.DSA&lt;/exclude&gt;</span><br><span class="line">                                        &lt;exclude&gt;META-INF/*.RSA&lt;/exclude&gt;</span><br><span class="line">                                    &lt;/excludes&gt;</span><br><span class="line">                                &lt;/filter&gt;</span><br><span class="line">                            &lt;/filters&gt;</span><br><span class="line">                            &lt;transformers&gt;</span><br><span class="line">                                &lt;transformer implementation=&quot;org.apache.maven.plugins.shade.resource.ManifestResourceTransformer&quot;&gt;</span><br><span class="line">                                    &lt;mainClass&gt;&lt;/mainClass&gt;</span><br><span class="line">                                &lt;/transformer&gt;</span><br><span class="line">                            &lt;/transformers&gt;</span><br><span class="line">                        &lt;/configuration&gt;</span><br><span class="line">                    &lt;/execution&gt;</span><br><span class="line">                &lt;/executions&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">    &lt;/build&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>

<p>java代码:</p>
<ol>
<li>定义一个类CustomParameterInterceptor实现Interceptor接口。</li>
<li>在CustomParameterInterceptor类中定义变量，这些变量是需要到<br>Flume的配置文件中进行配置使用的。每一行字段间的分隔符(fields_separator)、通过分隔符分隔后，所需要列字段的下标（indexs）、多个下标使用的分隔符（indexs_separator)、多个下标使用的分隔符（indexs_separator)。</li>
<li>添加CustomParameterInterceptor的有参构造方法。并对相应的变量进行处理</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">import com.google.common.base.Charsets;</span><br><span class="line">import org.apache.flume.Context;</span><br><span class="line">import org.apache.flume.Event;</span><br><span class="line">import org.apache.flume.interceptor.Interceptor;</span><br><span class="line"></span><br><span class="line">import java.security.MessageDigest;</span><br><span class="line">import java.security.NoSuchAlgorithmException;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.regex.Matcher;</span><br><span class="line">import java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line">import static cn.baidu.interceptor.CustomParameterInterceptor.Constants.*;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by itcast</span><br><span class="line"> */</span><br><span class="line">public class CustomParameterInterceptor implements Interceptor&#123;</span><br><span class="line">    /** The field_separator.指明每一行字段的分隔符 */</span><br><span class="line">  private final String fields_separator;</span><br><span class="line"></span><br><span class="line">  /** The indexs.通过分隔符分割后，指明需要那列的字段 下标*/</span><br><span class="line">  private final String indexs;</span><br><span class="line"></span><br><span class="line">  /** The indexs_separator. 多个下标的分隔符*/</span><br><span class="line">  private final String indexs_separator;</span><br><span class="line"></span><br><span class="line">  /** The encrypted_field_index. 需要加密的字段下标*/</span><br><span class="line">  private final String encrypted_field_index;</span><br><span class="line">  /**</span><br><span class="line">   *</span><br><span class="line">   */</span><br><span class="line">  public CustomParameterInterceptor( String fields_separator,</span><br><span class="line">                                     String indexs, String indexs_separator,String encrypted_field_index) &#123;</span><br><span class="line">      String f = fields_separator.trim();</span><br><span class="line">      String i = indexs_separator.trim();</span><br><span class="line">      this.indexs = indexs;</span><br><span class="line">      this.encrypted_field_index=encrypted_field_index.trim();</span><br><span class="line">      if (!f.equals(&quot;&quot;)) &#123;</span><br><span class="line">          f = UnicodeToString(f);</span><br><span class="line">      &#125;</span><br><span class="line">      this.fields_separator =f;</span><br><span class="line">      if (!i.equals(&quot;&quot;)) &#123;</span><br><span class="line">          i = UnicodeToString(i);</span><br><span class="line">      &#125;</span><br><span class="line">      this.indexs_separator = i;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>\t 制表符 的UNicode编码格式为(‘\u0009’)</p>
<p>将配置文件中传过来的unicode编码进行转换为字符串。</p>
<p>写具体的要处理的逻辑intercept()方法，一个是单个处理的，一个是批量处理。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">public static String UnicodeToString(String str) &#123;</span><br><span class="line">     Pattern pattern = Pattern.compile(&quot;(\\\\u(\\p&#123;XDigit&#125;&#123;4&#125;))&quot;);</span><br><span class="line">     Matcher matcher = pattern.matcher(str);</span><br><span class="line">     char ch;</span><br><span class="line">     while (matcher.find()) &#123;</span><br><span class="line">         ch = (char) Integer.parseInt(matcher.group(2), 16);</span><br><span class="line">         str = str.replace(matcher.group(1), ch + &quot;&quot;);</span><br><span class="line">     &#125;</span><br><span class="line">     return str;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> /*</span><br><span class="line">  * @see org.apache.flume.interceptor.Interceptor#intercept(org.apache.flume.Event)</span><br><span class="line">  */</span><br><span class="line"> public Event intercept(Event event) &#123;</span><br><span class="line">     if (event == null) &#123;</span><br><span class="line">         return null;</span><br><span class="line">     &#125;</span><br><span class="line">     try &#123;</span><br><span class="line">         String line = new String(event.getBody(), Charsets.UTF_8);</span><br><span class="line">         String[] fields_spilts = line.split(fields_separator);</span><br><span class="line">         String[] indexs_split = indexs.split(indexs_separator);</span><br><span class="line">         String newLine=&quot;&quot;;</span><br><span class="line">         for (int i = 0; i &lt; indexs_split.length; i++) &#123;</span><br><span class="line">             int parseInt = Integer.parseInt(indexs_split[i]);</span><br><span class="line">             //对加密字段进行加密</span><br><span class="line">             if(!&quot;&quot;.equals(encrypted_field_index)&amp;&amp;encrypted_field_index.equals(indexs_split[i]))&#123;</span><br><span class="line">                 newLine+=StringUtils.GetMD5Code(fields_spilts[parseInt]);</span><br><span class="line">             &#125;else&#123;</span><br><span class="line">                 newLine+=fields_spilts[parseInt];</span><br><span class="line">             &#125;</span><br><span class="line"></span><br><span class="line">             if(i!=indexs_split.length-1)&#123;</span><br><span class="line">                 newLine+=fields_separator;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         event.setBody(newLine.getBytes(Charsets.UTF_8));</span><br><span class="line">         return event;</span><br><span class="line">     &#125; catch (Exception e) &#123;</span><br><span class="line">         return event;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> /*</span><br><span class="line">  * @see org.apache.flume.interceptor.Interceptor#intercept(java.util.List)</span><br><span class="line">  */</span><br><span class="line"> public List&lt;Event&gt; intercept(List&lt;Event&gt; events) &#123;</span><br><span class="line">     List&lt;Event&gt; out = new ArrayList&lt;Event&gt;();</span><br><span class="line">     for (Event event : events) &#123;</span><br><span class="line">         Event outEvent = intercept(event);</span><br><span class="line">         if (outEvent != null) &#123;</span><br><span class="line">             out.add(outEvent);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     return out;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> /*</span><br><span class="line">  * @see org.apache.flume.interceptor.Interceptor#initialize()</span><br><span class="line">  */</span><br><span class="line"> public void initialize() &#123;</span><br><span class="line">     // TODO Auto-generated method stub</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> /*</span><br><span class="line">  * @see org.apache.flume.interceptor.Interceptor#close()</span><br><span class="line">  */</span><br><span class="line"> public void close() &#123;</span><br><span class="line">     // TODO Auto-generated method stub</span><br><span class="line"></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>接口中定义了一个内部接口Builder，在configure方法中，进行一些参数配置。并给出，在flume的conf中没配置一些参数时，给出其默认值。通过其builder方法，返回一个CustomParameterInterceptor对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">public static class Builder implements Interceptor.Builder &#123;</span><br><span class="line"></span><br><span class="line">      /** The fields_separator.指明每一行字段的分隔符 */</span><br><span class="line">      private  String fields_separator;</span><br><span class="line"></span><br><span class="line">      /** The indexs.通过分隔符分割后，指明需要那列的字段 下标*/</span><br><span class="line">      private  String indexs;</span><br><span class="line"></span><br><span class="line">      /** The indexs_separator. 多个下标下标的分隔符*/</span><br><span class="line">      private  String indexs_separator;</span><br><span class="line"></span><br><span class="line">      /** The encrypted_field. 需要加密的字段下标*/</span><br><span class="line">      private  String encrypted_field_index;</span><br><span class="line"></span><br><span class="line">      /*</span><br><span class="line">       * @see org.apache.flume.conf.Configurable#configure(org.apache.flume.Context)</span><br><span class="line">       */</span><br><span class="line">      public void configure(Context context) &#123;</span><br><span class="line">          fields_separator = context.getString(FIELD_SEPARATOR, DEFAULT_FIELD_SEPARATOR);</span><br><span class="line">          indexs = context.getString(INDEXS, DEFAULT_INDEXS);</span><br><span class="line">          indexs_separator = context.getString(INDEXS_SEPARATOR, DEFAULT_INDEXS_SEPARATOR);</span><br><span class="line">          encrypted_field_index= context.getString(ENCRYPTED_FIELD_INDEX, DEFAULT_ENCRYPTED_FIELD_INDEX);</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      /*</span><br><span class="line">       * @see org.apache.flume.interceptor.Interceptor.Builder#build()</span><br><span class="line">       */</span><br><span class="line">      public Interceptor build() &#123;</span><br><span class="line"></span><br><span class="line">          return new CustomParameterInterceptor(fields_separator, indexs, indexs_separator,encrypted_field_index);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">/**</span><br><span class="line"> * The Class Constants.</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">public static class Constants &#123;</span><br><span class="line">    /** The Constant FIELD_SEPARATOR. */</span><br><span class="line">    public static final String FIELD_SEPARATOR = &quot;fields_separator&quot;;</span><br><span class="line"></span><br><span class="line">    /** The Constant DEFAULT_FIELD_SEPARATOR. */</span><br><span class="line">    public static final String DEFAULT_FIELD_SEPARATOR =&quot; &quot;;</span><br><span class="line"></span><br><span class="line">    /** The Constant INDEXS. */</span><br><span class="line">    public static final String INDEXS = &quot;indexs&quot;;</span><br><span class="line"></span><br><span class="line">    /** The Constant DEFAULT_INDEXS. */</span><br><span class="line">    public static final String DEFAULT_INDEXS = &quot;0&quot;;</span><br><span class="line"></span><br><span class="line">    /** The Constant INDEXS_SEPARATOR. */</span><br><span class="line">    public static final String INDEXS_SEPARATOR = &quot;indexs_separator&quot;;</span><br><span class="line"></span><br><span class="line">    /** The Constant DEFAULT_INDEXS_SEPARATOR. */</span><br><span class="line">    public static final String DEFAULT_INDEXS_SEPARATOR = &quot;,&quot;;</span><br><span class="line"></span><br><span class="line">    /** The Constant ENCRYPTED_FIELD_INDEX. */</span><br><span class="line">    public static final String ENCRYPTED_FIELD_INDEX = &quot;encrypted_field_index&quot;;</span><br><span class="line"></span><br><span class="line">    /** The Constant DEFAUL_TENCRYPTED_FIELD_INDEX. */</span><br><span class="line">    public static final String DEFAULT_ENCRYPTED_FIELD_INDEX = &quot;&quot;;</span><br><span class="line"></span><br><span class="line">    /** The Constant PROCESSTIME. */</span><br><span class="line">    public static final String PROCESSTIME = &quot;processTime&quot;;</span><br><span class="line">    /** The Constant PROCESSTIME. */</span><br><span class="line">    public static final String DEFAULT_PROCESSTIME = &quot;a&quot;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义一个静态类，类中封装MD5加密方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">  * 字符串md5加密</span><br><span class="line">  */</span><br><span class="line"> public static class StringUtils &#123;</span><br><span class="line">     // 全局数组</span><br><span class="line">     private final static String[] strDigits = &#123; &quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;,</span><br><span class="line">             &quot;6&quot;, &quot;7&quot;, &quot;8&quot;, &quot;9&quot;, &quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;, &quot;e&quot;, &quot;f&quot; &#125;;</span><br><span class="line"></span><br><span class="line">     // 返回形式为数字跟字符串</span><br><span class="line">     private static String byteToArrayString(byte bByte) &#123;</span><br><span class="line">         int iRet = bByte;</span><br><span class="line">         // System.out.println(&quot;iRet=&quot;+iRet);</span><br><span class="line">         if (iRet &lt; 0) &#123;</span><br><span class="line">             iRet += 256;</span><br><span class="line">         &#125;</span><br><span class="line">         int iD1 = iRet / 16;</span><br><span class="line">         int iD2 = iRet % 16;</span><br><span class="line">         return strDigits[iD1] + strDigits[iD2];</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     // 返回形式只为数字</span><br><span class="line">     private static String byteToNum(byte bByte) &#123;</span><br><span class="line">         int iRet = bByte;</span><br><span class="line">         System.out.println(&quot;iRet1=&quot; + iRet);</span><br><span class="line">         if (iRet &lt; 0) &#123;</span><br><span class="line">             iRet += 256;</span><br><span class="line">         &#125;</span><br><span class="line">         return String.valueOf(iRet);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     // 转换字节数组为16进制字串</span><br><span class="line">     private static String byteToString(byte[] bByte) &#123;</span><br><span class="line">         StringBuffer sBuffer = new StringBuffer();</span><br><span class="line">         for (int i = 0; i &lt; bByte.length; i++) &#123;</span><br><span class="line">             sBuffer.append(byteToArrayString(bByte[i]));</span><br><span class="line">         &#125;</span><br><span class="line">         return sBuffer.toString();</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     public static String GetMD5Code(String strObj) &#123;</span><br><span class="line">         String resultString = null;</span><br><span class="line">         try &#123;</span><br><span class="line">             resultString = new String(strObj);</span><br><span class="line">             MessageDigest md = MessageDigest.getInstance(&quot;MD5&quot;);</span><br><span class="line">             // md.digest() 该函数返回值为存放哈希值结果的byte数组</span><br><span class="line">             resultString = byteToString(md.digest(strObj.getBytes()));</span><br><span class="line">         &#125; catch (NoSuchAlgorithmException ex) &#123;</span><br><span class="line">             ex.printStackTrace();</span><br><span class="line">         &#125;</span><br><span class="line">         return resultString;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>通过以上步骤，自定义拦截器的代码开发已完成，然后打包成jar，放到Flume的根目录下的lib中</p>
<p>新增配置文件: vim spool-interceptor-hdfs.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">a1.channels = c1</span><br><span class="line">a1.sources = r1</span><br><span class="line">a1.sinks = s1</span><br><span class="line"></span><br><span class="line">#channel</span><br><span class="line">a1.channels.c1.type = memory</span><br><span class="line">a1.channels.c1.capacity=1000</span><br><span class="line">a1.channels.c1.transactionCapacity=200</span><br><span class="line"></span><br><span class="line">#source</span><br><span class="line">a1.sources.r1.channels = c1</span><br><span class="line">a1.sources.r1.type = spooldir</span><br><span class="line">a1.sources.r1.spoolDir = /root/logs4/</span><br><span class="line">a1.sources.r1.batchSize= 50</span><br><span class="line">a1.sources.r1.inputCharset = UTF-8</span><br><span class="line"></span><br><span class="line">a1.sources.r1.interceptors =i1 i2</span><br><span class="line">a1.sources.r1.interceptors.i1.type =cn.baidu.interceptor.CustomParameterInterceptor$Builder</span><br><span class="line">a1.sources.r1.interceptors.i1.fields_separator=\\u0009</span><br><span class="line">a1.sources.r1.interceptors.i1.indexs =0,1,3,5,6</span><br><span class="line">a1.sources.r1.interceptors.i1.indexs_separator =\\u002c</span><br><span class="line">a1.sources.r1.interceptors.i1.encrypted_field_index =0</span><br><span class="line"></span><br><span class="line">a1.sources.r1.interceptors.i2.type = org.apache.flume.interceptor.TimestampInterceptor$Builder</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#sink</span><br><span class="line">a1.sinks.s1.channel = c1</span><br><span class="line">a1.sinks.s1.type = hdfs</span><br><span class="line">a1.sinks.s1.hdfs.path =hdfs://node01:9000/intercept/%Y%m%d</span><br><span class="line">a1.sinks.s1.hdfs.filePrefix = itcasr</span><br><span class="line">a1.sinks.s1.hdfs.fileSuffix = .dat</span><br><span class="line">a1.sinks.s1.hdfs.rollSize = 10485760</span><br><span class="line">a1.sinks.s1.hdfs.rollInterval =20</span><br><span class="line">a1.sinks.s1.hdfs.rollCount = 0</span><br><span class="line">a1.sinks.s1.hdfs.batchSize = 2</span><br><span class="line">a1.sinks.s1.hdfs.round = true</span><br><span class="line">a1.sinks.s1.hdfs.roundUnit = minute</span><br><span class="line">a1.sinks.s1.hdfs.threadsPoolSize = 25</span><br><span class="line">a1.sinks.s1.hdfs.useLocalTimeStamp = true</span><br><span class="line">a1.sinks.s1.hdfs.minBlockReplicas = 1</span><br><span class="line">a1.sinks.s1.hdfs.fileType =DataStream</span><br><span class="line">a1.sinks.s1.hdfs.writeFormat = Text</span><br><span class="line">a1.sinks.s1.hdfs.callTimeout = 60000</span><br><span class="line">a1.sinks.s1.hdfs.idleTimeout =60</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//启动</span><br><span class="line">bin/flume-ng agent -c conf -f conf/spool-interceptor-hdfs.conf -n a1 -Dflume.root.logger=INFO,console</span><br></pre></td></tr></table></figure>

<p>#九 自定义组件</p>
<h2 id="1flume自定义source"><a href="#1flume自定义source" class="headerlink" title="1flume自定义source"></a>1flume自定义source</h2><h3 id="说明"><a href="#说明" class="headerlink" title="说明:"></a>说明:</h3><p> Source是负责接收数据到Flume Agent的组件。Source组件可以处理各种类型、各种格式的日志数据，包括avro、thrift、exec、jms、spooling directory、netcat、sequence generator、syslog、http、legacy。官方提供的source类型已经很多，但是有时候并不能满足实际开发当中的需求，此时我们就需要根据实际需求自定义某些source。</p>
<p>如：实时监控MySQL，从MySQL中获取数据传输到HDFS或者其他存储框架，所以此时需要我们自己实现<strong>MySQLSource</strong>。</p>
<p>官方也提供了自定义source的接口：</p>
<p>官网说明：<a href="https://flume.apache.org/FlumeDeveloperGuide.html#source" target="_blank" rel="noopener">https://flume.apache.org/FlumeDeveloperGuide.html#source</a></p>
<h3 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理:"></a>实现原理:</h3><p>根据官方说明自定义mysqlsource需要继承AbstractSource类并实现Configurable和PollableSource接口。</p>
<p>实现相应方法：</p>
<p>getBackOffSleepIncrement() //此处暂不用</p>
<p>getMaxBackOffSleepInterval() //此处暂不用</p>
<p>configure(Context context) //初始化context</p>
<p>process() //获取数据（从mysql获取数据，业务处理比较复杂，所以我们定义一个专门的类——QueryMysql来处理跟mysql的交互），封装成event并写入channel，这个方法被循环调用</p>
<p>stop() //关闭相关的资源</p>
<p>###实现:</p>
<p>创建数据库及表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE `mysqlsource`;</span><br><span class="line"></span><br><span class="line">USE `mysqlsource`;</span><br><span class="line"></span><br><span class="line">/*Table structure for table `flume_meta` */</span><br><span class="line">DROP TABLE</span><br><span class="line">IF EXISTS `flume_meta`;</span><br><span class="line"></span><br><span class="line">CREATE TABLE `flume_meta` (</span><br><span class="line">	`source_tab` VARCHAR (255) NOT NULL,</span><br><span class="line">	`currentIndex` VARCHAR (255) NOT NULL,</span><br><span class="line">	PRIMARY KEY (`source_tab`)</span><br><span class="line">) ENGINE = INNODB DEFAULT CHARSET = utf8;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/*Table structure for table `student` */</span><br><span class="line">DROP TABLE</span><br><span class="line">IF EXISTS `student`;</span><br><span class="line"></span><br><span class="line">CREATE TABLE `student` (</span><br><span class="line">	`id` INT (11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">	`name` VARCHAR (255) NOT NULL,</span><br><span class="line">	PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE = INNODB AUTO_INCREMENT = 5 DEFAULT CHARSET = utf8;</span><br><span class="line"></span><br><span class="line">/*Data for the table `student` */</span><br><span class="line">INSERT INTO `student` (`id`, `name`)</span><br><span class="line">VALUES</span><br><span class="line">	(1, &apos;zhangsan&apos;),</span><br><span class="line">	(2, &apos;lisi&apos;),</span><br><span class="line">	(3, &apos;wangwu&apos;),</span><br><span class="line">	(4, &apos;zhaoliu&apos;);</span><br></pre></td></tr></table></figure>

<p>pom.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;</span><br><span class="line">         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line"></span><br><span class="line">    &lt;groupId&gt;cn.baidu.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;example-flume&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.1&lt;/version&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.flume&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;flume-ng-core&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.8.0&lt;/version&gt;</span><br><span class="line">            &lt;scope&gt;provided&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;5.1.38&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;commons-lang3&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;3.6&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">         &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.16.22&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;3.0&lt;/version&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;source&gt;1.8&lt;/source&gt;</span><br><span class="line">                    &lt;target&gt;1.8&lt;/target&gt;</span><br><span class="line">                    &lt;encoding&gt;UTF-8&lt;/encoding&gt;</span><br><span class="line">                    &lt;!--    &lt;verbal&gt;true&lt;/verbal&gt;--&gt;</span><br><span class="line">                &lt;/configuration&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;maven-shade-plugin&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;3.1.1&lt;/version&gt;</span><br><span class="line">                &lt;executions&gt;</span><br><span class="line">                    &lt;execution&gt;</span><br><span class="line">                        &lt;phase&gt;package&lt;/phase&gt;</span><br><span class="line">                        &lt;goals&gt;</span><br><span class="line">                            &lt;goal&gt;shade&lt;/goal&gt;</span><br><span class="line">                        &lt;/goals&gt;</span><br><span class="line">                        &lt;configuration&gt;</span><br><span class="line">                            &lt;filters&gt;</span><br><span class="line">                                &lt;filter&gt;</span><br><span class="line">                                    &lt;artifact&gt;*:*&lt;/artifact&gt;</span><br><span class="line">                                    &lt;excludes&gt;</span><br><span class="line">                                        &lt;exclude&gt;META-INF/*.SF&lt;/exclude&gt;</span><br><span class="line">                                        &lt;exclude&gt;META-INF/*.DSA&lt;/exclude&gt;</span><br><span class="line">                                        &lt;exclude&gt;META-INF/*.RSA&lt;/exclude&gt;</span><br><span class="line">                                    &lt;/excludes&gt;</span><br><span class="line">                                &lt;/filter&gt;</span><br><span class="line">                            &lt;/filters&gt;</span><br><span class="line">                            &lt;transformers&gt;</span><br><span class="line">                                &lt;transformer implementation=&quot;org.apache.maven.plugins.shade.resource.ManifestResourceTransformer&quot;&gt;</span><br><span class="line">                                    &lt;mainClass&gt;&lt;/mainClass&gt;</span><br><span class="line">                                &lt;/transformer&gt;</span><br><span class="line">                            &lt;/transformers&gt;</span><br><span class="line">                        &lt;/configuration&gt;</span><br><span class="line">                    &lt;/execution&gt;</span><br><span class="line">                &lt;/executions&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">    &lt;/build&gt;</span><br><span class="line"></span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>

<p>自定义QueryMySql工具类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br></pre></td><td class="code"><pre><span class="line">package cn.baidu.flumesource;</span><br><span class="line"></span><br><span class="line">import org.apache.flume.Context;</span><br><span class="line">import org.apache.flume.conf.ConfigurationException;</span><br><span class="line">import org.apache.http.ParseException;</span><br><span class="line">import org.slf4j.Logger;</span><br><span class="line">import org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line">import java.sql.*;</span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Properties;</span><br><span class="line">@Data</span><br><span class="line">@Getter</span><br><span class="line">@Setter</span><br><span class="line">public class QueryMySql &#123;</span><br><span class="line">    private static final Logger LOG = LoggerFactory.getLogger(QueryMySql.class);</span><br><span class="line"></span><br><span class="line">    private int runQueryDelay, //两次查询的时间间隔</span><br><span class="line">            startFrom,            //开始id</span><br><span class="line">            currentIndex,	     //当前id</span><br><span class="line">            recordSixe = 0,      //每次查询返回结果的条数</span><br><span class="line">            maxRow;                //每次查询的最大条数</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    private String table,       //要操作的表</span><br><span class="line">            columnsToSelect,     //用户传入的查询的列</span><br><span class="line">            customQuery,          //用户传入的查询语句</span><br><span class="line">            query,                 //构建的查询语句</span><br><span class="line">            defaultCharsetResultSet;//编码集</span><br><span class="line"></span><br><span class="line">    //上下文，用来获取配置文件</span><br><span class="line">    private Context context;</span><br><span class="line"></span><br><span class="line">    //为定义的变量赋值（默认值），可在flume任务的配置文件中修改</span><br><span class="line">    private static final int DEFAULT_QUERY_DELAY = 10000;</span><br><span class="line">    private static final int DEFAULT_START_VALUE = 0;</span><br><span class="line">    private static final int DEFAULT_MAX_ROWS = 2000;</span><br><span class="line">    private static final String DEFAULT_COLUMNS_SELECT = &quot;*&quot;;</span><br><span class="line">    private static final String DEFAULT_CHARSET_RESULTSET = &quot;UTF-8&quot;;</span><br><span class="line"></span><br><span class="line">    private static Connection conn = null;</span><br><span class="line">    private static PreparedStatement ps = null;</span><br><span class="line">    private static String connectionURL, connectionUserName, connectionPassword;</span><br><span class="line"></span><br><span class="line">    //加载静态资源</span><br><span class="line">    static &#123;</span><br><span class="line">        Properties p = new Properties();</span><br><span class="line">        try &#123;</span><br><span class="line">            p.load(QueryMySql.class.getClassLoader().getResourceAsStream(&quot;jdbc.properties&quot;));</span><br><span class="line">            connectionURL = p.getProperty(&quot;dbUrl&quot;);</span><br><span class="line">            connectionUserName = p.getProperty(&quot;dbUser&quot;);</span><br><span class="line">            connectionPassword = p.getProperty(&quot;dbPassword&quot;);</span><br><span class="line">            Class.forName(p.getProperty(&quot;dbDriver&quot;));</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            LOG.error(e.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //获取JDBC连接</span><br><span class="line">    private static Connection InitConnection(String url, String user, String pw) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Connection conn = DriverManager.getConnection(url, user, pw);</span><br><span class="line">            if (conn == null)</span><br><span class="line">                throw new SQLException();</span><br><span class="line">            return conn;</span><br><span class="line">        &#125; catch (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //构造方法</span><br><span class="line">    QueryMySql(Context context) throws ParseException &#123;</span><br><span class="line">        //初始化上下文</span><br><span class="line">        this.context = context;</span><br><span class="line"></span><br><span class="line">        //有默认值参数：获取flume任务配置文件中的参数，读不到的采用默认值</span><br><span class="line">        this.columnsToSelect = context.getString(&quot;columns.to.select&quot;, DEFAULT_COLUMNS_SELECT);</span><br><span class="line">        this.runQueryDelay = context.getInteger(&quot;run.query.delay&quot;, DEFAULT_QUERY_DELAY);</span><br><span class="line">        this.startFrom = context.getInteger(&quot;start.from&quot;, DEFAULT_START_VALUE);</span><br><span class="line">        this.defaultCharsetResultSet = context.getString(&quot;default.charset.resultset&quot;, DEFAULT_CHARSET_RESULTSET);</span><br><span class="line"></span><br><span class="line">        //无默认值参数：获取flume任务配置文件中的参数</span><br><span class="line">        this.table = context.getString(&quot;table&quot;);</span><br><span class="line">        this.customQuery = context.getString(&quot;custom.query&quot;);</span><br><span class="line">        connectionURL = context.getString(&quot;connection.url&quot;);</span><br><span class="line">        connectionUserName = context.getString(&quot;connection.user&quot;);</span><br><span class="line">        connectionPassword = context.getString(&quot;connection.password&quot;);</span><br><span class="line">        conn = InitConnection(connectionURL, connectionUserName, connectionPassword);</span><br><span class="line"></span><br><span class="line">        //校验相应的配置信息，如果没有默认值的参数也没赋值，抛出异常</span><br><span class="line">        checkMandatoryProperties();</span><br><span class="line">        //获取当前的id</span><br><span class="line">        currentIndex = getStatusDBIndex(startFrom);</span><br><span class="line">        //构建查询语句</span><br><span class="line">        query = buildQuery();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //校验相应的配置信息（表，查询语句以及数据库连接的参数）</span><br><span class="line">    private void checkMandatoryProperties() &#123;</span><br><span class="line">        if (table == null) &#123;</span><br><span class="line">            throw new ConfigurationException(&quot;property table not set&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        if (connectionURL == null) &#123;</span><br><span class="line">            throw new ConfigurationException(&quot;connection.url property not set&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        if (connectionUserName == null) &#123;</span><br><span class="line">            throw new ConfigurationException(&quot;connection.user property not set&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        if (connectionPassword == null) &#123;</span><br><span class="line">            throw new ConfigurationException(&quot;connection.password property not set&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //构建sql语句</span><br><span class="line">    private String buildQuery() &#123;</span><br><span class="line">        String sql = &quot;&quot;;</span><br><span class="line">        //获取当前id</span><br><span class="line">        currentIndex = getStatusDBIndex(startFrom);</span><br><span class="line">        LOG.info(currentIndex + &quot;&quot;);</span><br><span class="line">        if (customQuery == null) &#123;</span><br><span class="line">            sql = &quot;SELECT &quot; + columnsToSelect + &quot; FROM &quot; + table;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            sql = customQuery;</span><br><span class="line">        &#125;</span><br><span class="line">        StringBuilder execSql = new StringBuilder(sql);</span><br><span class="line">        //以id作为offset</span><br><span class="line">        if (!sql.contains(&quot;where&quot;)) &#123;</span><br><span class="line">            execSql.append(&quot; where &quot;);</span><br><span class="line">            execSql.append(&quot;id&quot;).append(&quot;&gt;&quot;).append(currentIndex);</span><br><span class="line">            return execSql.toString();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            int length = execSql.toString().length();</span><br><span class="line">            return execSql.toString().substring(0, length - String.valueOf(currentIndex).length()) + currentIndex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //执行查询</span><br><span class="line">    List&lt;List&lt;Object&gt;&gt; executeQuery() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //每次执行查询时都要重新生成sql，因为id不同</span><br><span class="line">            customQuery = buildQuery();</span><br><span class="line">            //存放结果的集合</span><br><span class="line">            List&lt;List&lt;Object&gt;&gt; results = new ArrayList&lt;&gt;();</span><br><span class="line">            if (ps == null) &#123;</span><br><span class="line">                //</span><br><span class="line">                ps = conn.prepareStatement(customQuery);</span><br><span class="line">            &#125;</span><br><span class="line">            ResultSet result = ps.executeQuery(customQuery);</span><br><span class="line">            while (result.next()) &#123;</span><br><span class="line">                //存放一条数据的集合（多个列）</span><br><span class="line">                List&lt;Object&gt; row = new ArrayList&lt;&gt;();</span><br><span class="line">                //将返回结果放入集合</span><br><span class="line">                for (int i = 1; i &lt;= result.getMetaData().getColumnCount(); i++) &#123;</span><br><span class="line">                    row.add(result.getObject(i));</span><br><span class="line">                &#125;</span><br><span class="line">                results.add(row);</span><br><span class="line">            &#125;</span><br><span class="line">            LOG.info(&quot;execSql:&quot; + customQuery + &quot;\nresultSize:&quot; + results.size());</span><br><span class="line">            return results;</span><br><span class="line">        &#125; catch (SQLException e) &#123;</span><br><span class="line">            LOG.error(e.toString());</span><br><span class="line">            // 重新连接</span><br><span class="line">            conn = InitConnection(connectionURL, connectionUserName, connectionPassword);</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //将结果集转化为字符串，每一条数据是一个list集合，将每一个小的list集合转化为字符串</span><br><span class="line">    List&lt;String&gt; getAllRows(List&lt;List&lt;Object&gt;&gt; queryResult) &#123;</span><br><span class="line">        List&lt;String&gt; allRows = new ArrayList&lt;&gt;();</span><br><span class="line">        if (queryResult == null || queryResult.isEmpty())</span><br><span class="line">            return allRows;</span><br><span class="line">        StringBuilder row = new StringBuilder();</span><br><span class="line">        for (List&lt;Object&gt; rawRow : queryResult) &#123;</span><br><span class="line">            Object value = null;</span><br><span class="line">            for (Object aRawRow : rawRow) &#123;</span><br><span class="line">                value = aRawRow;</span><br><span class="line">                if (value == null) &#123;</span><br><span class="line">                    row.append(&quot;,&quot;);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    row.append(aRawRow.toString()).append(&quot;,&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            allRows.add(row.toString());</span><br><span class="line">            row = new StringBuilder();</span><br><span class="line">        &#125;</span><br><span class="line">        return allRows;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //更新offset元数据状态，每次返回结果集后调用。必须记录每次查询的offset值，为程序中断续跑数据时使用，以id为offset</span><br><span class="line">    void updateOffset2DB(int size) &#123;</span><br><span class="line">        //以source_tab做为KEY，如果不存在则插入，存在则更新（每个源表对应一条记录）</span><br><span class="line">        String sql = &quot;insert into flume_meta(source_tab,currentIndex) VALUES(&apos;&quot;</span><br><span class="line">                + this.table</span><br><span class="line">                + &quot;&apos;,&apos;&quot; + (recordSixe += size)</span><br><span class="line">                + &quot;&apos;) on DUPLICATE key update source_tab=values(source_tab),currentIndex=values(currentIndex)&quot;;</span><br><span class="line">        LOG.info(&quot;updateStatus Sql:&quot; + sql);</span><br><span class="line">        execSql(sql);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //执行sql语句</span><br><span class="line">    private void execSql(String sql) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            ps = conn.prepareStatement(sql);</span><br><span class="line">            LOG.info(&quot;exec::&quot; + sql);</span><br><span class="line">            ps.execute();</span><br><span class="line">        &#125; catch (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //获取当前id的offset</span><br><span class="line">    private Integer getStatusDBIndex(int startFrom) &#123;</span><br><span class="line">        //从flume_meta表中查询出当前的id是多少</span><br><span class="line">        String dbIndex = queryOne(&quot;select currentIndex from flume_meta where source_tab=&apos;&quot; + table + &quot;&apos;&quot;);</span><br><span class="line">        if (dbIndex != null) &#123;</span><br><span class="line">            return Integer.parseInt(dbIndex);</span><br><span class="line">        &#125;</span><br><span class="line">        //如果没有数据，则说明是第一次查询或者数据表中还没有存入数据，返回最初传入的值</span><br><span class="line">        return startFrom;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //查询一条数据的执行语句(当前id)</span><br><span class="line">    private String queryOne(String sql) &#123;</span><br><span class="line">        ResultSet result = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            ps = conn.prepareStatement(sql);</span><br><span class="line">            result = ps.executeQuery();</span><br><span class="line">            while (result.next()) &#123;</span><br><span class="line">                return result.getString(1);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        return null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //关闭相关资源</span><br><span class="line">    void close() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            ps.close();</span><br><span class="line">            conn.close();</span><br><span class="line">        &#125; catch (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>自定义MySqlSource主类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">package cn.baidu.flumesource;</span><br><span class="line"></span><br><span class="line">import org.apache.flume.Context;</span><br><span class="line">import org.apache.flume.Event;</span><br><span class="line">import org.apache.flume.EventDeliveryException;</span><br><span class="line">import org.apache.flume.PollableSource;</span><br><span class="line">import org.apache.flume.conf.Configurable;</span><br><span class="line">import org.apache.flume.event.SimpleEvent;</span><br><span class="line">import org.apache.flume.source.AbstractSource;</span><br><span class="line">import org.slf4j.Logger;</span><br><span class="line"></span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.List;</span><br><span class="line"></span><br><span class="line">import static org.slf4j.LoggerFactory.*;</span><br><span class="line"></span><br><span class="line">public class MySqlSource extends AbstractSource implements Configurable, PollableSource &#123;</span><br><span class="line"></span><br><span class="line">    //打印日志</span><br><span class="line">    private static final Logger LOG = getLogger(MySqlSource.class);</span><br><span class="line">    //定义sqlHelper</span><br><span class="line">    private QueryMySql sqlSourceHelper;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public long getBackOffSleepIncrement() &#123;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public long getMaxBackOffSleepInterval() &#123;</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void configure(Context context) &#123;</span><br><span class="line">        //初始化</span><br><span class="line">        sqlSourceHelper = new QueryMySql(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public PollableSource.Status process() throws EventDeliveryException &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //查询数据表</span><br><span class="line">            List&lt;List&lt;Object&gt;&gt; result = sqlSourceHelper.executeQuery();</span><br><span class="line">            //存放event的集合</span><br><span class="line">            List&lt;Event&gt; events = new ArrayList&lt;&gt;();</span><br><span class="line">            //存放event头集合</span><br><span class="line">            HashMap&lt;String, String&gt; header = new HashMap&lt;&gt;();</span><br><span class="line">            //如果有返回数据，则将数据封装为event</span><br><span class="line">            if (!result.isEmpty()) &#123;</span><br><span class="line">                List&lt;String&gt; allRows = sqlSourceHelper.getAllRows(result);</span><br><span class="line">                Event event = null;</span><br><span class="line">                for (String row : allRows) &#123;</span><br><span class="line">                    event = new SimpleEvent();</span><br><span class="line">                    event.setBody(row.getBytes());</span><br><span class="line">                    event.setHeaders(header);</span><br><span class="line">                    events.add(event);</span><br><span class="line">                &#125;</span><br><span class="line">                //将event写入channel</span><br><span class="line">                this.getChannelProcessor().processEventBatch(events);</span><br><span class="line">                //更新数据表中的offset信息</span><br><span class="line">                sqlSourceHelper.updateOffset2DB(result.size());</span><br><span class="line">            &#125;</span><br><span class="line">            //等待时长</span><br><span class="line">            Thread.sleep(sqlSourceHelper.getRunQueryDelay());</span><br><span class="line">            return Status.READY;</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            LOG.error(&quot;Error procesing row&quot;, e);</span><br><span class="line">            return Status.BACKOFF;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public synchronized void stop() &#123;</span><br><span class="line">        LOG.info(&quot;Stopping sql source &#123;&#125; ...&quot;, getName());</span><br><span class="line">        try &#123;</span><br><span class="line">            //关闭资源</span><br><span class="line">            sqlSourceHelper.close();</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            super.stop();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用maven对工程进行打包，需要将mysql的依赖包一起打到jar包里，然后将打包好的jar包放到flume的lib目录下。</p>
<p>配置文件: vim mysqlsource.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">a1.sources = r1</span><br><span class="line">a1.sinks = k1</span><br><span class="line">a1.channels = c1</span><br><span class="line"></span><br><span class="line"># Describe/configure the source</span><br><span class="line">a1.sources.r1.type = cn.baidu.flumesource.MySqlSource</span><br><span class="line">a1.sources.r1.connection.url = jdbc:mysql://node01:3306/mysqlsource</span><br><span class="line">a1.sources.r1.connection.user = root</span><br><span class="line">a1.sources.r1.connection.password = hadoop</span><br><span class="line">a1.sources.r1.table = student</span><br><span class="line">a1.sources.r1.columns.to.select = *</span><br><span class="line">a1.sources.r1.incremental.column.name = id</span><br><span class="line">a1.sources.r1.incremental.value = 0</span><br><span class="line">a1.sources.r1.run.query.delay=3000</span><br><span class="line"></span><br><span class="line"># Describe the sink</span><br><span class="line">a1.sinks.k1.type = logger</span><br><span class="line"></span><br><span class="line"># Describe the channel</span><br><span class="line">a1.channels.c1.type = memory</span><br><span class="line">a1.channels.c1.capacity = 1000</span><br><span class="line">a1.channels.c1.transactionCapacity = 100</span><br><span class="line"></span><br><span class="line"># Bind the source and sink to the channel</span><br><span class="line">a1.sources.r1.channels = c1</span><br><span class="line">a1.sinks.k1.channel = c1</span><br></pre></td></tr></table></figure>

<p>启动:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/flume-ng agent -c conf -fconf/mysqlsource.conf -n a1 -Dflume.root.logger=INFO,console</span><br></pre></td></tr></table></figure>

<h2 id="2flume自定义sink"><a href="#2flume自定义sink" class="headerlink" title="2flume自定义sink"></a>2flume自定义sink</h2><p>###说明:</p>
<p>同自定义source类似，对于某些sink如果没有我们想要的，我们也可以自定义sink实现将数据保存到我们想要的地方去，例如kafka，或者mysql，或者文件等等都可以</p>
<p>需求：从网络端口当中发送数据，自定义sink，使用sink从网络端口接收数据，然后将数据保存到本地文件当中去。</p>
<p>pom.xml 同自定义source</p>
<p>自定义mysink</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">package cn.baidu.flumesink;</span><br><span class="line"></span><br><span class="line">import org.apache.commons.io.FileUtils;</span><br><span class="line">import org.apache.flume.*;</span><br><span class="line">import org.apache.flume.conf.Configurable;</span><br><span class="line">import org.apache.flume.sink.AbstractSink;</span><br><span class="line"></span><br><span class="line">import java.io.*;</span><br><span class="line"></span><br><span class="line">public class MySink extends AbstractSink implements Configurable &#123;</span><br><span class="line">    private Context context ;</span><br><span class="line">    private String filePath = &quot;&quot;;</span><br><span class="line">    private String fileName = &quot;&quot;;</span><br><span class="line">    private File fileDir;</span><br><span class="line"></span><br><span class="line">    //这个方法会在初始化调用，主要用于初始化我们的Context，获取我们的一些配置参数</span><br><span class="line">    @Override</span><br><span class="line">    public void configure(Context context) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            this.context = context;</span><br><span class="line">            filePath = context.getString(&quot;filePath&quot;);</span><br><span class="line">            fileName = context.getString(&quot;fileName&quot;);</span><br><span class="line">            fileDir = new File(filePath);</span><br><span class="line">            if(!fileDir.exists())&#123;</span><br><span class="line">                fileDir.mkdirs();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //这个方法会被反复调用</span><br><span class="line">    @Override</span><br><span class="line">    public Status process() throws EventDeliveryException &#123;</span><br><span class="line">        Event event = null;</span><br><span class="line">        Channel channel = this.getChannel();</span><br><span class="line">        Transaction transaction = channel.getTransaction();</span><br><span class="line">        transaction.begin();</span><br><span class="line">        while(true)&#123;</span><br><span class="line">            event = channel.take();</span><br><span class="line">            if(null != event)&#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        byte[] body = event.getBody();</span><br><span class="line">        String line = new String(body);</span><br><span class="line">        try &#123;</span><br><span class="line">            FileUtils.write(new File(filePath+File.separator+fileName),line,true);</span><br><span class="line">            transaction.commit();</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            transaction.rollback();</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            return Status.BACKOFF;</span><br><span class="line">        &#125;finally &#123;</span><br><span class="line">            transaction.close();</span><br><span class="line">        &#125;</span><br><span class="line">        return Status.READY;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将代码使用打包插件，打成jar包，注意一定要将commons-langs这个依赖包打进去，放到flume的lib目录下</p>
<p>配置conf文件 vim filesink.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">a1.sources = r1</span><br><span class="line">a1.sinks = k1</span><br><span class="line">a1.channels = c1</span><br><span class="line"># Describe/configure the source</span><br><span class="line">a1.sources.r1.type = netcat</span><br><span class="line">a1.sources.r1.bind = node01</span><br><span class="line">a1.sources.r1.port = 5678</span><br><span class="line">a1.sources.r1.channels = c1</span><br><span class="line"># # Describe the sink</span><br><span class="line">a1.sinks.k1.type = cn.baidu.flumesink.MySink</span><br><span class="line">a1.sinks.k1.filePath=/export/servers</span><br><span class="line">a1.sinks.k1.fileName=filesink.txt</span><br><span class="line"># # Use a channel which buffers events in memory</span><br><span class="line">a1.channels.c1.type = memory</span><br><span class="line">a1.channels.c1.capacity = 1000</span><br><span class="line">a1.channels.c1.transactionCapacity = 100</span><br><span class="line"># # Bind the source and sink to the channel</span><br><span class="line">a1.sources.r1.channels = c1</span><br><span class="line">a1.sinks.k1.channel = c1</span><br></pre></td></tr></table></figure>

<p>启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/flume-ng agent -c conf -f conf/filesink.conf -n a1 -Dflume.root.logger=INFO,console</span><br></pre></td></tr></table></figure>

<p>Telnet node01 5678 连接到机器端口上输入数据</p>
</div><div class="post-copyright"><blockquote><p>Ursprünglicher Autor: hechao</p><p>Ursprünglicher Link: <a href="http://yoursite.com/2017/03/08/Flume/">http://yoursite.com/2017/03/08/Flume/</a></p><p>Copyright-Erklärung: Bitte geben Sie die Quelle des Nachdrucks an.</p></blockquote></div><div class="tags"></div><div class="post-share"><div class="social-share"><span>Aktie:</span></div></div><div class="post-nav"><a href="/2017/04/18/Hadoop/" class="pre">Hadoop</a><a href="/2017/02/28/ElSearh/" class="next">ElSearh</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">Inhalte</i></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#一-概述"><span class="toc-text">一 概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#二-运行机制"><span class="toc-text">二 运行机制</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#三-安装部署"><span class="toc-text">三 安装部署</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#四-测试环境"><span class="toc-text">四 测试环境:</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#五-采集目录到hdfs"><span class="toc-text">五 采集目录到hdfs:</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#六-采集文件到HDFS"><span class="toc-text">六 采集文件到HDFS</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#七-Flume的load-balance、failover"><span class="toc-text">七 Flume的load-balance、failover</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-负载均衡"><span class="toc-text">1 负载均衡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-flume-failover"><span class="toc-text">2 flume failover</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#八-flume拦截器"><span class="toc-text">八 flume拦截器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-静态拦截器-日志的采集与汇总"><span class="toc-text">1 静态拦截器 日志的采集与汇总</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-自定义拦截器"><span class="toc-text">2 自定义拦截器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1flume自定义source"><span class="toc-text">1flume自定义source</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#说明"><span class="toc-text">说明:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实现原理"><span class="toc-text">实现原理:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2flume自定义sink"><span class="toc-text">2flume自定义sink</span></a></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> Letzte</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/08/24/sparkSql高级/">sparkSql高级</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/20/sparkSQL/">sparkSQL</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/18/spark原理分析2/">spark原理分析2</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/10/spark原理分析/">spark原理分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/08/SparkRDD/">SparkRDD</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/08/Spark入门/">Spark入门</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/24/shell/">shell</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/18/Scala高级/">Scala高级</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/04/Yarn-资源调度/">Yarn-资源调度</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/27/Scala进阶2/">Scala进阶2</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> Tags</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> Archiv</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li></ul></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Sitemap</a> |  <a href="/atom.xml">Abonnieren Sie diese Site</a> |  <a href="/about/">Kontaktieren Sie den Blogger</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次，本站总访客数:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>人</p><p><span> Copyright &copy;<a href="/." rel="nofollow">hechao.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.4"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.4" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script></body></html>